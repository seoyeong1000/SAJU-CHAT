# PRD1 FINAL â€” ë§Œì„¸ë ¥(ëª…ì‹) ê³„ì‚° ì—”ì§„

- ë²„ì „: v1.3
- ìµœì¢… ì—…ë°ì´íŠ¸: 2025-12-21 (Asia/Seoul)
- ìƒíƒœ: FINAL

## ì´ë²ˆ í†µí•© ì—…ê·¸ë ˆì´ë“œì—ì„œ â€œíŒ¨ì¹˜ë¡œë§Œ ìˆë˜ ë‚´ìš©â€ì„ ë³¸ë¬¸ì— í¡ìˆ˜í•œ í•­ëª©
- ê³µí†µ(NFR): Legal/SEO/OG/Sentry/Support + ë³´ì•ˆ/ë ˆì´íŠ¸ë¦¬ë°‹/ë©±ë“±/ë¡œê·¸/ë°±ì—…/ë§ˆì´ê·¸ë ˆì´ì…˜/ë¹„ìš©í†µì œ
- DB Source of Truth: entitlement-ì°¨íŠ¸ ë°”ì¸ë”© 1:1, ë¦¬í¬íŠ¸ ìŠ¤ëƒ…ìƒ· ë¶ˆë³€, ì°¨íŠ¸ ì‚­ì œ ê¸ˆì§€(Lock A), ìƒì„± ë©±ë“±/ë³µêµ¬(Lock B), ì±„íŒ… ì°¨ê° ì›ìí™” RPC, ì¥ë¶€(credit_logs) ìœ ë‹ˆí¬
- Seed/ETL: `npm run seed` + íŒŒì¼ë³„ ë§¤í•‘ ê·œê²© + ë©±ë“±/ê²€ì¦/ì²­í¬ ì²˜ë¦¬
- í™˜ê²½ë³€ìˆ˜: `.env.example` ê°•ì œ

## ê³µí†µ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­(ì´ PRDì— ë°˜ë“œì‹œ ì ìš©)
> ì•„ë˜ ê·œì¹™ì€ â€œê¸°ëŠ¥â€ì´ ì•„ë‹ˆë¼ â€œì„œë¹„ìŠ¤ê°€ ìš´ì˜ ê°€ëŠ¥í•œì§€â€ë¥¼ ê²°ì •í•˜ëŠ” **ê°•ì œ ìŠ¤í™**ì…ë‹ˆë‹¤.

1) **í´ë¼ì´ì–¸íŠ¸ â†’ n8n ì§ê²° ê¸ˆì§€**: ëª¨ë“  í˜¸ì¶œì€ Next.js Gatewayë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰  
2) **ìœ ë£Œ í•„í„°ë§/ê¶Œí•œ íŒì •ì€ ì„œë²„ê°€ ì§„ì‹¤**: í”„ë¡ íŠ¸ì—ì„œ ìˆ¨ê¹€ìœ¼ë¡œ ë•Œìš°ì§€ ì•ŠìŒ  
3) **ë©±ë“±ì„±/ì›ìì„±**: ê²°ì œ/ë¦¬í¬íŠ¸ ìƒì„±/ìƒë‹´ ì°¨ê°ì€ ì¤‘ë³µ ì‹¤í–‰ë¼ë„ 1ë²ˆë§Œ ì²˜ë¦¬  
4) **ê´€ì¸¡ ê°€ëŠ¥ì„±**: request_id + Sentry + ìš´ì˜ ë¡œê·¸ í‘œì¤€  
5) **Seed/í™˜ê²½ë³€ìˆ˜**: ë¹ˆ DBì— ë°ì´í„°/í‚¤ ë„£ëŠ” ì ˆì°¨ê°€ ì—†ìœ¼ë©´ ë°°í¬ ë¶ˆê°€

- ìƒì„¸ ê·œê²©ì€ ë¬¸ì„œ í•˜ë‹¨ ë¶€ë¡(NFR/DB/Seed)ì„ ê·¸ëŒ€ë¡œ ë”°ë¥¸ë‹¤.

---

ğŸ“˜ Bazi Ephemeris Engine PRD â€“ Final v2.2
0. ë¬¸ì„œ ì •ë³´

í”„ë¡œì íŠ¸ëª…: Bazi Ephemeris Engine (ë§Œì„¸ë ¥ ê³„ì‚° ì½”ì–´)

ë²„ì „: v2.2 Final

ì‘ì„±ì: PM/CTO

ëŒ€ìƒ: ë°±ì—”ë“œ ê°œë°œì, ì¸í”„ë¼ ì—”ì§€ë‹ˆì–´, AI ì—ì´ì „íŠ¸(Cursor/Codex)

ëª©í‘œ:

Swiss Ephemeris ê¸°ë°˜ ì •ë°€ ë§Œì„¸ë ¥ ì—”ì§„ì„ Next.js + Node í™˜ê²½ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ëŒë¦°ë‹¤.

ìœˆë„ìš° ê°œë°œ í™˜ê²½ + ë¦¬ëˆ…ìŠ¤(AWS/Railway) ë°°í¬ í™˜ê²½ ëª¨ë‘ ë™ì¼ ì½”ë“œë¡œ ë™ì‘í•˜ê²Œ í•œë‹¤.

ê°œë°œ ë‹¨ê³„ì—ì„œëŠ” RLS ë¹„í™œì„±í™”, ìš´ì˜ ì „í™˜ ì‹œì—ë§Œ RLSë¥¼ ì¼œëŠ” ì „ëµì„ ëª…í™•íˆ í•œë‹¤.

ì´ PRDëŠ” **â€œë§Œì„¸ë ¥/ì²œë¬¸ ê³„ì‚° ì—”ì§„â€**ë§Œ ë‹¤ë£¹ë‹ˆë‹¤.
ì‚¬ì£¼ í’€ì´(í†µë³€) ë£°ì—”ì§„, ì‚¬ì£¼ ì±„íŒ…ë´‡ì€ ë³„ë„ PRD(v1.x, v3.x)ì—ì„œ ì •ì˜.

1. ì„¤ê³„ ë°©í–¥ ìš”ì•½ (Architecture Summary)
1.1 ê¸°ì¡´ ì•ˆ vs ìµœì¢… ì•ˆ

âŒ ê¸°ì¡´ ì•ˆ:

Windows ì „ìš© swetest.exe ë°”ì´ë„ˆë¦¬ë¥¼ child_processë¡œ í˜¸ì¶œ.

C ì½”ë“œë¥¼ TypeScriptë¡œ ì§ì ‘ í¬íŒ… ì‹œë„.

âœ… ìµœì¢… ì•ˆ:

NPM Swiss Ephemeris ë¼ì´ë¸ŒëŸ¬ë¦¬(Node ë°”ì¸ë”©/wasm)ë¥¼ ì‚¬ìš©.

OS ë…ë¦½ì ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ ì„¤ê³„ (Windows Dev â†” Linux Prod ë™ì¼ ì½”ë“œ).

1.2 ê¸°ìˆ  ìŠ¤íƒ

ëŸ°íƒ€ì„: Node.js (Next.js 15 App Router, API Route)

ë§Œì„¸ë ¥ ì—”ì§„:

1ìˆœìœ„: swisseph-v2
 
packages.ecosyste.ms

2ìˆœìœ„(ìœˆë„ìš° ë¹Œë“œ ì‹¤íŒ¨ ì‹œ): swisseph-wasm 
packages.ecosyste.ms

ë³´ì¡° ì—”ì§„(ë°±ì—…): date-chinese (ë‹¨ìˆœ ê°„ì§€ ê³„ì‚°ìš©)

DB: Supabase(PostgreSQL)

ì¸ì¦/ì—°ë™: Clerk â†” Supabase (ì´ PRDì—ì„œëŠ” ì„¸ë¶€ ì¸ì¦ ë¡œì§ì€ ë²”ìœ„ ë°–)

1.3 ê¸ˆì§€ ì‚¬í•­ (Hard NO)

âŒ Swiss C ì½”ë“œë¥¼ TypeScriptë¡œ ì§ì ‘ í¬íŒ…(C â†’ TS ë³€í™˜)
â†’ ì •ë°€ë„ ë§ê°€ì§ˆ ìœ„í—˜ì´ í¬ë¯€ë¡œ ì ˆëŒ€ ê¸ˆì§€.

âŒ .exe ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ í›„ child_process.execë¡œ í˜¸ì¶œ
â†’ ë¦¬ëˆ…ìŠ¤ ì»¨í…Œì´ë„ˆ/ì„œë²„ë¦¬ìŠ¤ì—ì„œ ê¹¨ì§ˆ ê°€ëŠ¥ì„±ì´ í¼.

âœ… ë°˜ë“œì‹œ NPM íŒ¨í‚¤ì§€(swisseph-v2 / swisseph-wasm) ë¥¼ ì‚¬ìš©í•´ í˜¸ì¶œí•  ê²ƒ.

2. Cursor / Codexìš© ê°œë°œ ì§€ì‹œë¬¸

ì´ ì„¹ì…˜ì€ ê·¸ëŒ€ë¡œ ë³µë¶™í•´ì„œ Cursorì—ê²Œ ì£¼ëŠ” ìš©ë„ì…ë‹ˆë‹¤.

2.1 ë°©í–¥ ì „í™˜ ì„¤ëª…
PRDì—ëŠ” ì›ë˜ Windowsìš© EXE(swetest.exe)ë¥¼ child_processë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì´ ìˆì—ˆëŠ”ë°,
ë°°í¬ í™˜ê²½ì´ AWSë‚˜ Railway ê°™ì€ ë¦¬ëˆ…ìŠ¤/ì»¨í…Œì´ë„ˆê°€ ë  ê²ƒì´ê¸° ë•Œë¬¸ì—
ì´ì œëŠ” .exe íŒŒì¼ì„ ì§ì ‘ ì‹¤í–‰í•˜ì§€ ì•Šê³ ,

Node.js ìš© Swiss Ephemeris ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ npmìœ¼ë¡œ ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•œë‹¤.

2.2 Cursorì— ì¤„ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ â‘  (ì—”ì§„ ì„¸íŒ…)
ìƒê°í•´ë³´ë‹ˆ ë‚˜ì¤‘ì— AWSë‚˜ Railway(ë¦¬ëˆ…ìŠ¤ í™˜ê²½)ì— ë°°í¬í•´ì•¼ í•´ì„œ,
`.exe` íŒŒì¼ì„ ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì€ ê´€ë¦¬ê°€ ì–´ë ¤ìš¸ ê²ƒ ê°™ì•„.

ëŒ€ì‹ , Node.jsìš© Swiss Ephemeris ë¼ì´ë¸ŒëŸ¬ë¦¬(`swisseph-v2` ìš°ì„ , ì•ˆë˜ë©´ `swisseph-wasm`)ë¥¼
npmìœ¼ë¡œ ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•´ì¤˜.

1. `package.json`ì— `swisseph-v2`ë¥¼ ì¶”ê°€í•´ì¤˜.
   - ë§Œì•½ ë‚´ ê°œë°œ PC(Windows)ì—ì„œ native ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ë©´, ìë™ìœ¼ë¡œ `swisseph-wasm` ë²„ì „ìœ¼ë¡œ ëŒ€ì²´í•´ì¤˜.

2. `lib/bazi/engine.ts` íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ,
   - `swisseph-v2` (ë˜ëŠ” fallbackìœ¼ë¡œ `swisseph-wasm`)ë¥¼ importí•´ì„œ ì‚¬ìš©í•˜ëŠ” êµ¬ì¡°ë¡œ ì‘ì„±í•´ì¤˜.
   - ì ˆëŒ€ë¡œ `child_process`ë¡œ exeë¥¼ ë¶€ë¥´ì§€ ë§ê³ , ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ì¤˜.

3. Ephemeris ë°ì´í„° íŒŒì¼(ephe)ì€ í”„ë¡œì íŠ¸ ë‚´ì˜ `public/ephe` í´ë”ì— ë‘˜ ì˜ˆì •ì´ì•¼.
   - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™” ì‹œ `swe_set_ephe_path` ê°™ì€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ
     ì´ ê²½ë¡œë¥¼ ë°”ë¼ë³´ë„ë¡ ì„¤ì •í•´ì¤˜.

ì´ë ‡ê²Œ í•˜ë©´ Windows ê°œë°œí™˜ê²½ê³¼ Linux ë°°í¬í™˜ê²½ ëª¨ë‘ì—ì„œ
ì½”ë“œ ìˆ˜ì • ì—†ì´ ë™ì¼í•˜ê²Œ ë™ì‘í•  ìˆ˜ ìˆê²Œ í•´ì¤˜.

2.3 Cursorì— ì¤„ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ â‘¡ (í…ŒìŠ¤íŠ¸ í•¨ìˆ˜)
`swisseph-v2`ë¥¼ ì˜ ì„¤ì¹˜í–ˆë‹¤ë©´, ë‹¤ìŒ ì‘ì—…ì„ í•´ì¤˜.

1. í„°ë¯¸ë„ì—ì„œ `pnpm add swisseph-v2 date-chinese` ë¥¼ ì‹¤í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸/ëª…ë ¹ì–´ë¥¼ READMEë‚˜ docsì— ì¶”ê°€í•´ì¤˜.

2. ì„¤ì¹˜ê°€ ëë‚¬ë‹¤ê³  ê°€ì •í•˜ê³ ,
   `lib/bazi/engine.ts` ì•ˆì— ì•„ë˜ ë‚´ìš©ì„ í¬í•¨í•œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì¤˜.

   - `swisseph.swe_julday` ë¥¼ ì‚¬ìš©í•´ì„œ
     2024-02-04 12:00:00 UTC ì˜ ìœ¨ë¦¬ìš°ìŠ¤ì¼(Julian day)ì„ ê³„ì‚°í•˜ëŠ” ì˜ˆì œ
   - `swisseph.swe_set_ephe_path(process.cwd() + "/public/ephe")` ë¡œ ê²½ë¡œë¥¼ ì„¸íŒ…í•˜ëŠ” ì½”ë“œ
   - ê³„ì‚° ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” `testSwissConnection()` ê°™ì€ í•¨ìˆ˜

3. ì´ í•¨ìˆ˜ëŠ” ë‚˜ì¤‘ì— `/api/bazi-test` ê°™ì€ ë¼ìš°íŠ¸ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆê²Œ
   export í•´ì¤˜.

3. ì…ë ¥/ì¶œë ¥ ìŠ¤í™ (API Spec)
3.1 Endpoint

URL: POST /api/bazi

ì—­í• :

ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¶œìƒ ì‹œê° + ì¥ì†Œ ì •ë³´ë¥¼ ë°›ì•„

ì›”ì£¼/ì¼ì£¼/ì‹œì£¼ë¥¼ í¬í•¨í•œ **ì›ì‹œ ì²œë¬¸ ë°ì´í„°(raw_chart)**ë¥¼ ë°˜í™˜í•œë‹¤.

3.2 ìš”ì²­ ìŠ¤í‚¤ë§ˆ (Request JSON)
{
  "localWallTime": "2024-02-04T16:30:00",   // í•„ìˆ˜: ì‚¬ìš©ìê°€ ë³¸ ë²½ì‹œê³„ ì‹œê° (ì´ˆê¹Œì§€ í—ˆìš©)
  "tzid": "Asia/Seoul",                     // í•„ìˆ˜: IANA Time Zone
  "lon": 126.9780,                          // ì„ íƒ: ê²½ë„(+ë™ê²½). ì—†ìœ¼ë©´ ì§„íƒœì–‘ì‹œ ê³„ì‚° X
  "lat": 37.5665,                           // ì„ íƒ: ìœ„ë„(+ë¶ìœ„). v1ì—ì„œëŠ” ë©”íƒ€ë¡œë§Œ ì‚¬ìš©
  "options": {
    "useTrueSolarTime": true,               // ì§„íƒœì–‘ì‹œ ì ìš© ì—¬ë¶€ (ê¸°ë³¸ true)
    "zishiSplit": "traditional",            // 'traditional' | 'modern'
    "fallbackStrategy": "allowApprox"       // 'allowApprox' | 'strict'
  }
}


ì£¼ì˜:

localWallTimeì€ í•­ìƒ ì‚¬ìš©ìì˜ â€œì§€ì—­ ì‹œê°„â€ ê¸°ì¤€.

UTCë¡œ ë“¤ì–´ì˜¤ëŠ” ê°’ì´ ì•„ë‹˜. ë³€í™˜ì€ ì„œë²„ì—ì„œ tzidë¥¼ ì‚¬ìš©í•´ ì²˜ë¦¬.

3.3 ì‘ë‹µ ìŠ¤í‚¤ë§ˆ (Response JSON, ê°œìš”)
{
  "yearPillar": "ê°‘ì",
  "monthPillar": "ì„ì¶•",
  "dayPillar": "ë¬´ì¸",
  "hourPillar": "ê²½ì",
  "raw": {
    "julianDayUTC": 2460345.5,
    "sunLongitude": 315.1234
  },
  "flags": {
    "usedTrueSolarTime": true,
    "usedFallbackEngine": false,
    "hourUnknown": false,
    "locationUnknown": false
  },
  "meta": {
    "engine": "swiss-v2 | swisseph-wasm | date-chinese",
    "note": "ì›”ì§€=íƒœì–‘í™©ê²½(ì ˆê¸°), ì‹œì£¼=ì§„íƒœì–‘ì‹œ(ê²½ë„+EoT)",
    "debug": {
      "tzid": "Asia/Seoul",
      "tzOffsetMin": 540,
      "lon": 126.978,
      "localWallISO": "2024-02-04T16:30:00",
      "utcISO": "2024-02-04T07:30:00Z",
      "tstLocal": "2024-02-04T16:38:12",
      "eotMin": -1.3
    }
  }
}

4. ë¡œì§ ìƒì„¸ (ì›”ì£¼/ì‹œì£¼/ì§„íƒœì–‘ì‹œ)
4.1 ì‹œê°„ëŒ€/UTC ë³€í™˜

localWallTime + tzid â†’ UTC ë³€í™˜

date-fns-tz ë˜ëŠ” luxon ê³„ì—´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (ë‚´ë¶€ êµ¬í˜„ ì„ íƒ).

ì—­ì‚¬ì  DST(ì¸ë¨¸íƒ€ì„)ëŠ” tzidê°€ ì•Œì•„ì„œ ì²˜ë¦¬.

UTC ì‹œê° â†’ swissephì˜ swe_julday/swe_calc_utì— ì „ë‹¬.

4.2 ì›”ì£¼(æœˆæŸ±) ê³„ì‚° (íƒœì–‘ í™©ê²½ ê¸°ë°˜)

swisseph.swe_calc_ut(julianDayUTC, SE_SUN, ...)ë¡œ íƒœì–‘ í™©ê²½ Î»â˜‰ ê³„ì‚°.

315Â°ë¥¼ ì…ì¶˜(å¯…ì›”)ì˜ ì‹œì‘ì ìœ¼ë¡œ ë‘ê³ , 30Â° êµ¬ê°„ìœ¼ë¡œ ì›”ì§€ íŒì •:

[315Â°, 345Â°) â†’ å¯…

[345Â°, 15Â°) â†’ å¯

[15Â°, 45Â°) â†’ è¾°

â€¦

ê²½ê³„ ì²˜ë¦¬:

ì ˆì… ì‹œê°ì„ ë¶„/ì´ˆ ë‹¨ìœ„ê¹Œì§€ ê³„ì‚°í•˜ê³ ,

ì¶œìƒ ì‹œê°ì´ ì ˆì… ì‹œê° ì´í›„ì´ë©´ ìƒˆ ë‹¬ë¡œ íŒì •.

4.3 ì‹œì£¼(æ™‚æŸ±) & ìì‹œ ì •ì±…

ì§„íƒœì–‘ì‹œ(True Solar Time) ê³„ì‚°:

lonì´ ìˆìœ¼ë©´:

í‘œì¤€ì‹œ ê¸°ì¤€ì—ì„œ ê²½ë„ ë³´ì • + EoT(ì‹œë°©ì •ì‹)ë¥¼ ë”í•´ TST ì‚°ì¶œ.

lonì´ ì—†ìœ¼ë©´:

flags.usedTrueSolarTime = falseë¡œ ë‘ê³ , í‘œì¤€ì‹œ ê¸°ì¤€ìœ¼ë¡œë§Œ ì‹œì£¼ ê³„ì‚°.

zishiSplit ì˜µì…˜:

traditional (ê¸°ë³¸ê°’)

TST ê¸°ì¤€ 23:00ë¶€í„° ë‹¤ìŒ ë‚  ì¼ì§„ì„ ì ìš©.

23:00~01:00 = ìì‹œ, ì¼ì£¼ëŠ” ë‹¤ìŒ ë‚ .

modern

23:00~24:00 = ì•¼ìì‹œ (ì¼ì£¼ëŠ” ì˜¤ëŠ˜, ì‹œì§€ëŠ” ìì‹œ)

00:00~01:00 = ì¡°ìì‹œ (ì¼ì£¼ëŠ” ë‚´ì¼, ì‹œì§€ëŠ” ìì‹œ)

5. ì˜ˆì™¸ ì²˜ë¦¬ & Fallback ì „ëµ
5.1 Swiss ì—”ì§„ ì‹¤íŒ¨ ì‹œ

swisseph-v2 ë¡œë”© ì‹¤íŒ¨, ephe íŒŒì¼ ëˆ„ë½, ê³„ì‚° ì˜¤ë¥˜ ë“± ë°œìƒ ì‹œ:

fallbackStrategy === "allowApprox"ì´ë©´:

date-chinese ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì›”ì£¼/ì¼ì£¼/ì‹œì£¼ ë‹¨ìˆœ ê³„ì‚°.

flags.usedFallbackEngine = true

meta.engine = "date-chinese"

meta.debug.error í•„ë“œì— Swiss ì—ëŸ¬ ë©”ì‹œì§€ ê¸°ë¡.

fallbackStrategy === "strict"ì´ë©´:

HTTP 500 + ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜.

DBì— ì—ëŸ¬ ë¡œê·¸ ë‚¨ê¹€.

5.2 ìƒì‹œ/ì¥ì†Œ ë¯¸ìƒ

ìƒì‹œ ëª¨ë¦„:

í”„ë¡ íŠ¸ì—ì„œ ì‹œê°„ ì…ë ¥ì„ null/unknownìœ¼ë¡œ ë³´ë‚¼ ìˆ˜ ìˆê²Œ í•˜ê³ ,

ë°±ì—”ë“œì—ì„œ hourPillar = null, flags.hourUnknown = true.

ì¥ì†Œ ëª¨ë¦„:

lon, lat ëˆ„ë½ â†’ flags.locationUnknown = true,

ì§„íƒœì–‘ì‹œ(TST)ëŠ” ê³„ì‚°í•˜ì§€ ì•Šê³ , í‘œì¤€ì‹œë¡œë§Œ ì‹œì£¼ ê³„ì‚°.

6. DB ì„¤ê³„ & RLS ì •ì±…
6.1 í…Œì´ë¸” ê°œìš”

Dev ë‹¨ê³„ì—ì„œëŠ” RLS ì „ë¶€ ë¹„í™œì„±í™”. Prod ì „í™˜ ì‹œ ë³„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ í™œì„±í™”.

astro_request

id (uuid, pk)

input_json (jsonb)

created_at (timestamptz)

astro_result

id (uuid, pk)

request_id (uuid, fk â†’ astro_request.id)

output_json (jsonb)

engine_type (text) â€” 'swiss-v2' | 'swisseph-wasm' | 'date-chinese'

created_at (timestamptz)

astro_error_log

id (uuid, pk)

request_id (nullable, fk)

error_message (text)

stack (text)

created_at (timestamptz)

6.2 ì¸ë±ìŠ¤

astro_request (created_at DESC)

astro_result (request_id)

í•„ìš” ì‹œ astro_result (created_at DESC) ì¶”ê°€

6.3 RLS ì „ëµ

Dev / Stage:

ALTER TABLE ... DISABLE ROW LEVEL SECURITY;

ê°œë°œ í¸ì˜ë¥¼ ìœ„í•´ anon keyë¡œë„ read/write ê°€ëŠ¥.

Prod:

owner_id ì»¬ëŸ¼ ì¶”ê°€ í›„,
owner_id = auth.jwt()->>'sub' ê¸°ë°˜ RLS ì •ì±… ë³„ë„ PRD/ë§ˆì´ê·¸ë ˆì´ì…˜ì—ì„œ ì •ì˜.

7. ì„¤ì¹˜ & ê°œë°œ ê°€ì´ë“œ
7.1 íŒ¨í‚¤ì§€ ì„¤ì¹˜
# Swiss Ephemeris & ë³´ì¡° ì—”ì§„
pnpm add swisseph-v2 date-chinese

# Windowsì—ì„œ ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ë©´ (node-gyp ì—ëŸ¬ ë“±)
pnpm add swisseph-wasm

7.2 Ephemeris ë°ì´í„° íŒŒì¼

Swiss Ephemeris ê³µì‹ ì‚¬ì´íŠ¸ì—ì„œ ephe íŒŒì¼ ë‹¤ìš´

sepl_18.se1, semo_18.se1, seas_18.se1, sefstars.se1 ë“±

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— public/ephe/ ìƒì„± í›„ ë³µì‚¬.

ì´ˆê¸°í™” ì½”ë“œ (ì˜ˆì‹œ):

import swe from "swisseph-v2";
// ë˜ëŠ” import swe from "swisseph-wasm";

swe.swe_set_ephe_path(process.cwd() + "/public/ephe");

7.3 í™˜ê²½ ë³€ìˆ˜ ì˜ˆì‹œ
ENGINE_MODE=swiss          # swiss | date-chinese (fallback ì—”ì§„ ì„ íƒ)
FALLBACK_STRATEGY=allowApprox

NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...  # Devì—ì„  ê±°ì˜ ì‚¬ìš© X, Prodì—ì„œ ë°°ì¹˜/ê´€ë¦¬ìš©

8. í…ŒìŠ¤íŠ¸ & ê²€ì¦
8.1 ë²¤ì¹˜ë§ˆí¬ ì¼€ì´ìŠ¤

ì…ì¶˜ ê²½ê³„:

2ì›” 4ì¼ 16:28 vs 16:29 ë“±, ë¶„/ì´ˆ ì°¨ì´ë¡œ ì›”ì£¼ ë³€í™” í™•ì¸.

ì¸ë¨¸íƒ€ì„ ì ìš© ì—°ë„ (ì˜ˆ: 1988ë…„ í•œêµ­):

tzid=Asia/Seoul ê¸°ì¤€ DST ë°˜ì˜ ì—¬ë¶€ ê²€ì¦.

ì„œìš¸ vs ë¶€ì‚°:

ë™ì¼ ì‹œê°, ë‹¤ë¥¸ ê²½ë„ â†’ ì§„íƒœì–‘ì‹œ ê¸°ì¤€ ì‹œì£¼ ì°¨ì´ í™•ì¸.

ì¥ì†Œ/ìƒì‹œ ëª¨ë¦„:

lon, localWallTime ì¼ë¶€ ëˆ„ë½ ì‹œ flags ì²˜ë¦¬ì™€ ì˜¤ë¥˜ ì—†ëŠ” ì‘ë‹µ í™•ì¸.

8.2 ì„±ëŠ¥ ëª©í‘œ

ë‹¨ê±´ /api/bazi í˜¸ì¶œ:

í‰ê·  200ms ì´ë‚´ (swisseph ìºì‹œ/ephe íŒŒì¼ ë¡œì»¬ì¼ ë•Œ).

Fallback ë°œìƒë¥ :

ì „ì²´ í˜¸ì¶œì˜ 0.1% ë¯¸ë§Œ.

9. Definition of Done (ì™„ë£Œ ê¸°ì¤€)

 swisseph-v2 ë˜ëŠ” swisseph-wasmì„ ì‚¬ìš©í•´, Windows Dev + Linux Prodì—ì„œ ë™ì¼ ì½”ë“œë¡œ ë™ì‘.

 /api/baziì— ëŒ€í•œ ê¸°ë³¸ ë²¤ì¹˜ë§ˆí¬ ì¼€ì´ìŠ¤(ì…ì¶˜, DST, ì„œìš¸/ë¶€ì‚°)ê°€ ê¸°ëŒ€ê°’ê³¼ ì¼ì¹˜.

 Dev DBì—ì„œ RLS ë¹„í™œì„± ìƒíƒœë¡œ ë¡œê·¸/ê²°ê³¼ê°€ ì˜ ì €ì¥ë¨.

 Prod ì „í™˜ ì‹œ, RLS ì •ì±…ì€ ë³„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜/PRDë¡œ ê´€ë¦¬.

 /bazi-test í˜ì´ì§€ ë˜ëŠ” ìœ ì‚¬ í…ŒìŠ¤íŠ¸ UIì—ì„œ JSON ê²°ê³¼ì™€ debug ì •ë³´ë¥¼ ì‹œê° í™•ì¸ ê°€ëŠ¥.
---

# âœ… [ê°ë¦¬ ë°˜ì˜] Phase1 ë§Œì„¸ë ¥ â€œìˆ¨ê²¨ì§„ ì§€ë¢° 3ì¢…â€ ë°©ì§€ ìŠ¤í™ (Patch v1.0)

- ë°˜ì˜ì¼: 2025-12-21
- ì ìš© ëŒ€ìƒ: ë§Œì„¸ë ¥ ì…ë ¥/ê³„ì‚°/ê²°ê³¼ í˜ì´ì§€(ê²ŒìŠ¤íŠ¸ í¬í•¨) + ë°°í¬(AWS/Railway/Vercel)

> ë³¸ íŒ¨ì¹˜ ì„¹ì…˜ì€ ê¸°ì¡´ PRD1 ë³¸ë¬¸ì„ í›¼ì†í•˜ì§€ ì•ŠëŠ” **append-only** ê·œê²©ì…ë‹ˆë‹¤.  
> ê¸°ì¡´ ë³¸ë¬¸ê³¼ ì¶©ëŒ ì‹œ **ì´ ì„¹ì…˜ì„ ìš°ì„ ** ì ìš©í•©ë‹ˆë‹¤.

---

## 1) ì˜ˆì™¸ ì²˜ë¦¬: â€œì‹œê°„ ëª¨ë¦„(Unknown Time)â€ ì •ì±… (ê°•ì œ)

### 1.1 ì…ë ¥ ê·œê²©(ê°•ì œ)
- ì‚¬ìš©ìê°€ â€œì‹œê°„ ëª¨ë¦„â€ì„ ì²´í¬í•˜ë©´:
  - í´ë¼ì´ì–¸íŠ¸ëŠ” `birthTime`ì„ ì„ì˜ ê°’ìœ¼ë¡œ ì±„ìš°ì§€ ì•ŠëŠ”ë‹¤.
  - ì„œë²„ë¡œëŠ” `birthTime: null` ë¡œ ì „ì†¡í•œë‹¤.
  - ìš”ì²­ í˜ì´ë¡œë“œì— `timeAccuracy`ë¥¼ ëª…ì‹œí•œë‹¤:
    - `timeAccuracy: "exact" | "unknown"`

ì˜ˆì‹œ(Request)
```json
{
  "birthDate": "1990-01-01",
  "birthTime": null,
  "timeAccuracy": "unknown",
  "timezone": "Asia/Seoul",
  "location": {"lat": 37.456, "lng": 126.705}
}
```

### 1.2 ì„œë²„ ê³„ì‚° ê·œì¹™(ê°•ì œ)
- `timeAccuracy="unknown"` ì´ë©´:
  - **ì‹œì£¼(Hour Pillar)** ë° ì‹œì£¼ì— ì˜ì¡´í•˜ëŠ” íŒŒìƒê°’ì€ ê³„ì‚°í•˜ì§€ ì•ŠëŠ”ë‹¤.
  - ë°˜í™˜ê°’ì€ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ê³ ì •:
    - `hourPillar: null` (ê¶Œì¥)
    - ë˜ëŠ” `hourPillar.status = "unknown"`
- **ì ˆëŒ€ ê¸ˆì§€**: â€œê·¸ëŸ¼ 00:00(ìì‹œ)ìœ¼ë¡œ ê³„ì‚°â€ ê°™ì€ ì„ì˜ ë³´ì •

ì˜ˆì‹œ(Response)
```json
{
  "pillars": {
    "year": {"stem": "...", "branch": "..."},
    "month": {"stem": "...", "branch": "..."},
    "day": {"stem": "...", "branch": "..."},
    "hour": null
  },
  "timeAccuracy": "unknown"
}
```

### 1.3 ê²°ê³¼ UI ê·œì¹™(ê°•ì œ)
- ê²°ê³¼ í˜ì´ì§€ì—ì„œ ì‹œì£¼ ì˜ì—­ì€:
  - `ì‹œê°„ ëª¨ë¦„` ë˜ëŠ” `ë¯¸ìƒ(æœªè©³)` ìœ¼ë¡œ ëª…í™•íˆ í‘œê¸°
- ì‹œì£¼ ê¸°ë°˜ ê¸°ëŠ¥(ì˜ˆ: ì‹œì£¼ ì‹­ì‹ /12ìš´ì„±/ì‹ ì‚´ ì¼ë¶€ ë“±)ì´ ì¡´ì¬í•œë‹¤ë©´:
  - í•´ë‹¹ ì˜ì—­ì— `ì‹œê°„ ë¯¸ìƒìœ¼ë¡œ ê³„ì‚°ì—ì„œ ì œì™¸` ë°°ì§€/íˆ´íŒ ë…¸ì¶œ

---

## 2) ê²ŒìŠ¤íŠ¸ ë°ì´í„° íœ˜ë°œ ë°©ì§€: â€œìƒˆë¡œê³ ì¹¨(F5)ì—ë„ ìœ ì§€â€ (ê°•ì œ)

> âš ï¸ React stateë§Œ ì‚¬ìš©í•˜ë©´ 100% ë‚ ì•„ê°„ë‹¤.  
> ê²ŒìŠ¤íŠ¸ ì •ì±…ì´ â€œë¸Œë¼ìš°ì € ë‹«ìœ¼ë©´ ì‚¬ë¼ì§â€ì´ì–´ë„, **ìƒˆë¡œê³ ì¹¨ì€ ì‚¬ìš©ì ì‹¤ìˆ˜ë¡œ ìì£¼ ë°œìƒ**í•˜ë¯€ë¡œ ë°©ì–´í•´ì•¼ í•œë‹¤.

### 2.1 ì €ì¥ ìœ„ì¹˜(ê°•ì œ ìµœì†Œ)
- ê²ŒìŠ¤íŠ¸(ë¡œê·¸ì¸ ì „) ì…ë ¥ê°’/ê²°ê³¼ëŠ” **sessionStorage**ì— ì €ì¥í•œë‹¤.
  - ëª©í‘œ: **ê°™ì€ íƒ­ì—ì„œ ìƒˆë¡œê³ ì¹¨í•´ë„ ê²°ê³¼ ìœ ì§€**
  - íƒ­/ë¸Œë¼ìš°ì €ë¥¼ ë‹«ìœ¼ë©´ ìì—°íˆ ì‚¬ë¼ì§€ëŠ” ì„±ì§ˆì„ ì´ìš©(â€œì„ì‹œâ€ ì •ì±…ê³¼ë„ ë¶€í•©)

### 2.2 ì €ì¥ í‚¤/í˜•ì‹(ê¶Œì¥)
- `mansaeryeok:draft:v1` : ì…ë ¥ê°’ + createdAt
- `mansaeryeok:result:v1` : ê³„ì‚° ê²°ê³¼ + createdAt

ì˜ˆì‹œ
```json
{
  "createdAt": "2025-12-21T12:00:00+09:00",
  "payload": { "...": "..." }
}
```

### 2.3 ë¡œë”©/ë³µêµ¬ ê·œì¹™(ê°•ì œ)
- ê²°ê³¼ í˜ì´ì§€ ì§„ì… ì‹œ:
  1) sessionStorageì— `result`ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ë³µêµ¬ ë Œë”
  2) ì—†ìœ¼ë©´ â€œì„ì‹œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤â€ ì•ˆë‚´ + ì…ë ¥ í˜ì´ì§€ë¡œ ì´ë™ ë²„íŠ¼
- ê²°ê³¼ í˜ì´ì§€ ìƒë‹¨ ê³ ì • ë¬¸êµ¬(ê¸°ì¡´ ì •ì±… ìœ ì§€):
  - `ì§€ê¸ˆì€ ì„ì‹œ ê²°ê³¼ì…ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ ë‹«ìœ¼ë©´ ì‚¬ë¼ì ¸ìš”. [ë³´ê´€í•¨ì— ì˜êµ¬ ì €ì¥í•˜ê¸°]`

### 2.4 ë§Œë£Œ(ì„ íƒ)
- ë” ì•ˆì „í•˜ê²Œ í•˜ë ¤ë©´ `createdAt` ê¸°ì¤€ 1ì‹œê°„ TTL ì ìš© ê°€ëŠ¥(ì„ íƒ)
  - TTL ë§Œë£Œ ì‹œ sessionStorage ì‚­ì œ í›„ ì•ˆë‚´ í˜ì´ì§€ë¡œ

> ê¸°ë³¸ê°’: **TTL ì—†ìŒ**, ëŒ€ì‹  â€œíƒ­ ë‹«í˜=ì‚­ì œâ€ë¡œ ë‹¨ìˆœ ìš´ì˜(ì´ˆë³´ì ìš´ì˜ ì¹œí™”)

---

## 3) ë°°í¬ ì‚¬ê³  ë°©ì§€: Ephemeris íŒŒì¼ ëˆ„ë½ ë°©ì–´ (ê°•ì œ)

### 3.1 ì „ì œ
- `swisseph-wasm` ì‚¬ìš© ì‹œì—ë„ Ephemeris ë°ì´í„° íŒŒì¼(`*.se1`)ì´ í•„ìš”í•  ìˆ˜ ìˆë‹¤.
- ë¡œì»¬ì—ì„œëŠ” ì¡´ì¬í•˜ì§€ë§Œ ë°°í¬ ë¹Œë“œì—ì„œ ëˆ„ë½ë˜ëŠ” ì‚¬ê³ ê°€ ì¦ë‹¤.

### 3.2 í”„ë¡œì íŠ¸ ë°°ì¹˜(ê°•ì œ)
- Ephemeris íŒŒì¼ì€ ë¦¬í¬ì§€í† ë¦¬ì— í¬í•¨í•˜ê³ , ê²½ë¡œë¥¼ ê³ ì •í•œë‹¤:
  - `public/ephe/` (ê¶Œì¥)

### 3.3 ëŸ°íƒ€ì„ ê²½ë¡œ(ê°•ì œ)
- ì„œë²„ ëŸ°íƒ€ì„ì—ì„œ íŒŒì¼ ê²½ë¡œëŠ” ë°˜ë“œì‹œ `process.cwd()` ê¸°ì¤€ìœ¼ë¡œ ì¡ëŠ”ë‹¤(ìƒëŒ€ê²½ë¡œ ê¸ˆì§€):
  - ì˜ˆ: `path.join(process.cwd(), "public", "ephe")`

### 3.4 CI/CD ê²€ì¦(ê°•ì œ)
- ë¹Œë“œ ë‹¨ê³„ì—ì„œ ephe í´ë” ì¡´ì¬/íŒŒì¼ ìœ ë¬´ë¥¼ ê²€ì‚¬í•˜ê³ , ì—†ìœ¼ë©´ ë¹Œë“œë¥¼ ì‹¤íŒ¨ì‹œí‚¨ë‹¤.
- ê¶Œì¥ ìŠ¤í¬ë¦½íŠ¸:
  - `node scripts/verify-ephe.js`
- ê¶Œì¥ package.json:
```json
{
  "scripts": {
    "prebuild": "node scripts/verify-ephe.js",
    "build": "next build"
  }
}
```

### 3.5 ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸(í•„ìˆ˜)
- Railway/AWS ë°°í¬ ì‹œ:
  - `public/ephe`ê°€ ì´ë¯¸ì§€/ì•„í‹°íŒ©íŠ¸ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
  - ì»¨í…Œì´ë„ˆ ë¹Œë“œë¼ë©´ Dockerfileì—ì„œ `COPY public/ephe ./public/ephe` í¬í•¨ í™•ì¸

---

## 4) QA ì‹œë‚˜ë¦¬ì˜¤(ë°˜ë“œì‹œ í†µê³¼)
1) ì‹œê°„ ëª¨ë¦„ ì²´í¬ â†’ hourPillarê°€ null/unknown, UIì— â€œì‹œê°„ ëª¨ë¦„â€ í‘œì‹œ, ì„ì˜ ê³„ì‚° ê¸ˆì§€
2) ê²ŒìŠ¤íŠ¸ê°€ ê²°ê³¼ ë³´ê³  F5 â†’ ê²°ê³¼ ìœ ì§€(ê°™ì€ íƒ­)
3) ë°°í¬ í™˜ê²½ì—ì„œ ephe í´ë” ëˆ„ë½ â†’ ë¹Œë“œ ì‹¤íŒ¨(ìš´ì˜ ì‚¬ê³  ì „ ì°¨ë‹¨)
---

# âœ… [ì¶”ê°€ ê°ë¦¬ ë°˜ì˜] Phase1 ë§Œì„¸ë ¥ â€œì—­ì‚¬ì  ì‹œê°„ëŒ€/DSTâ€ ê°•ì œ ìŠ¤í™ (Patch v1.1)

- ë°˜ì˜ì¼: 2025-12-21
- ëª©ì : 1987~1988 DST(ì„œë¨¸íƒ€ì„) ë° ê³¼ê±° í‘œì¤€ì‹œ ë³€ë™ ë“± **ì—­ì‚¬ì  íƒ€ì„ì¡´**ì„ ë°˜ì˜í•˜ì—¬ ì‹œì£¼/ì ˆê¸° ê²½ê³„ ê³„ì‚° ì˜¤ë¥˜ë¥¼ ë°©ì§€í•œë‹¤.
- ì ìš© ìš°ì„ ìˆœìœ„: ê¸°ì¡´ ë³¸ë¬¸/ê¸°ì¡´ íŒ¨ì¹˜ì™€ ì¶©ëŒ ì‹œ **ë³¸ ì„¹ì…˜ ìš°ì„ **

---

## 1) ê¸ˆì§€ ê·œì¹™(ê°•ì œ): Date ê°ì²´ ì§í–‰ ê¸ˆì§€
- ë¡œì»¬(ë¯¼ê°„) ì‹œê°„ ì…ë ¥ì„ `new Date("YYYY-MM-DD HH:mm")` ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë°”ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ ê¸ˆì§€í•œë‹¤.
- ì´ìœ :
  - ë¸Œë¼ìš°ì €/ì„œë²„ ëŸ°íƒ€ì„ì˜ í•´ì„ ì°¨ì´
  - ê³¼ê±° DST/í‘œì¤€ì‹œ ë³€ë™ì˜ ëˆ„ë½/ì˜¤í•´ ê°€ëŠ¥ì„±
  - ê²°ê³¼ì ìœ¼ë¡œ **UTC ë³€í™˜ì´ í‹€ì–´ì ¸ ì‹œì£¼ê°€ ë°”ë€ŒëŠ”** ì¹˜ëª…ì  ì˜¤ë¥˜ê°€ ë°œìƒ

---

## 2) ê°•ì œ ê·œì¹™: Asia/Seoul â€œì—­ì‚¬ì  íƒ€ì„ì¡´â€ ê¸°ì¤€ìœ¼ë¡œ UTC ë³€í™˜ í›„ ì—”ì§„ì— íˆ¬ì…

### 2.1 ì…ë ¥(ê°•ì œ)
- í´ë¼ì´ì–¸íŠ¸ëŠ” í•­ìƒ ë‹¤ìŒì„ ì„œë²„ì— ì „ë‹¬í•œë‹¤:
  - `birthDate` (YYYY-MM-DD)
  - `birthTime` (HH:mm ë˜ëŠ” null)
  - `timezone` (ê³ ì •ê°’: "Asia/Seoul")
  - `timeAccuracy` ("exact" | "unknown")

### 2.2 ì„œë²„ ë³€í™˜(ê°•ì œ)
- ì„œë²„ëŠ” `timezone="Asia/Seoul"` ê¸°ì¤€ìœ¼ë¡œ **ì—­ì‚¬ì  íƒ€ì„ì¡´ì„ ë°˜ì˜í•´ UTCë¡œ ë³€í™˜**í•œ ë’¤,
- ê·¸ UTCë¥¼ ê¸°ë°˜ìœ¼ë¡œ Swiss Ephemeris(JD/UT)ë¥¼ ê³„ì‚°í•œë‹¤.

### 2.3 êµ¬í˜„ ìš”êµ¬ì‚¬í•­(ê°•ì œ)
- ì„œë²„ëŠ” ì•„ë˜ ì¤‘ 1ê°œ ì´ìƒì„ ì‚¬ìš©í•˜ì—¬ ë³€í™˜ì„ ìˆ˜í–‰í•œë‹¤:
  - **luxon**
  - **date-fns-tz**
- ë³€í™˜ ì‹œ ë°˜ë“œì‹œ IANA TZ("Asia/Seoul")ì„ ì‚¬ìš©í•´ì•¼ í•˜ë©°, â€œ+09:00 ê³ ì • ì˜¤í”„ì…‹â€ ë°©ì‹ì€ ê¸ˆì§€í•œë‹¤.

> ì°¸ê³ : í•œêµ­ì€ ê³¼ê±°ì— DST(ì„œë¨¸íƒ€ì„) ì ìš© ë° í‘œì¤€ì‹œ(UTC ì˜¤í”„ì…‹) ë³€ë™ ì´ë ¥ì´ ìˆìœ¼ë¯€ë¡œ,  
> â€˜í•­ìƒ +09:00â€™ìœ¼ë¡œ ê³ ì •í•˜ë©´ íŠ¹ì • ì—°ë„/ê¸°ê°„ì—ì„œ ì˜¤ì°¨ê°€ ë‚  ìˆ˜ ìˆë‹¤.

---

## 3) QA ì¼€ì´ìŠ¤(í•„ìˆ˜)
- 1987~1988ë…„ ì¶œìƒ ì¼€ì´ìŠ¤(DST ê¸°ê°„ í¬í•¨)ë¥¼ ìµœì†Œ 3ê±´ ì´ìƒ í…ŒìŠ¤íŠ¸í•œë‹¤.
- í…ŒìŠ¤íŠ¸ëŠ” ë°˜ë“œì‹œ â€œAsia/Seoul â†’ UTC ë³€í™˜ ê²°ê³¼ê°€ ê¸°ëŒ€ì™€ ì¼ì¹˜í•˜ëŠ”ì§€â€ë¶€í„° í™•ì¸í•œë‹¤.

(ê¶Œì¥) ìë™ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:
- ì…ë ¥: 1988-07-01 10:00 Asia/Seoul
- ê¸°ëŒ€: DST ë°˜ì˜ ì—¬ë¶€ì— ë”°ë¼ UTC ë³€í™˜ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸(í™˜ê²½ë³„ tzdata/ICU ì˜ì¡´)

---

## 4) ìš´ì˜ ê°€ì´ë“œ(í•„ìˆ˜)
- ë°°í¬ í™˜ê²½(Node.js)ì—ì„œ **ICU/ì‹œê°„ëŒ€ ë°ì´í„°ê°€ ì¶©ë¶„íˆ í¬í•¨ë˜ì–´ì•¼** í•œë‹¤.
- ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ë°°í¬ ì‹œ(íŠ¹íˆ Alpine ë“±) tzdata íŒ¨í‚¤ì§€ í¬í•¨ ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.
---

# âœ… [ì¶”ê°€ ê°ë¦¬ ë°˜ì˜] Phase1 ë§Œì„¸ë ¥ â€œDST ì „í™˜ ì‹œê°(ì¡´ì¬í•˜ì§€ ì•ŠìŒ/ëª¨í˜¸í•¨)â€ ë°©ì–´ + ìë™ ê²€ì¦ (Patch v1.2)

- ë°˜ì˜ì¼: 2025-12-21
- ëª©ì : í•œêµ­ DST(1987~1988) ì „í™˜ ì‹œê°ì—ì„œ ë°œìƒí•˜ëŠ” **ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‹œê°„(ìŠ¤í”„ë§ í¬ì›Œë“œ)** / **ëª¨í˜¸í•œ ì‹œê°„(í´ë°±)** ì„ ëª…ì„¸ë¡œ ì°¨ë‹¨í•˜ê³ ,
  ê°œë°œìê°€ ëŸ°íƒ€ì„/ë°°í¬ í™˜ê²½ì—ì„œ ì‹¤ìˆ˜í•˜ì§€ ì•Šë„ë¡ **ìë™ í…ŒìŠ¤íŠ¸ ë²¡í„°**ë¥¼ ì œê³µí•œë‹¤.

ê·¼ê±°(ì „í™˜ ì‹œê°):
- 1987ë…„ DST: 5/10 02:00 ì‹œì‘(KSTâ†’KDT), 10/11 03:00 ì¢…ë£Œ(KDTâ†’KST) îˆ€citeîˆ‚turn0search0îˆ‚turn0search2îˆ‚turn0search4îˆ
- 1988ë…„ DST: 5/8 02:00 ì‹œì‘(KSTâ†’KDT), 10/9 03:00 ì¢…ë£Œ(KDTâ†’KST) îˆ€citeîˆ‚turn0search1îˆ‚turn0search2îˆ‚turn0search5îˆ

---

## 1) â€œì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‹œê°„â€ ì…ë ¥ ë°©ì–´(ê°•ì œ)

### 1.1 ì •ì˜
DST ì‹œì‘ì¼ì˜ 02:00 â†’ 03:00 ì í”„ êµ¬ê°„ì—ëŠ” **02:00~02:59**ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤. îˆ€citeîˆ‚turn0search2îˆ‚turn0search1îˆ

### 1.2 ê°•ì œ ê·œì¹™
- ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‹œê°„ì„ ì…ë ¥í•˜ë©´:
  - ì„œë²„ëŠ” **422 Unprocessable Entity**ë¡œ ê±°ì ˆí•œë‹¤.
  - ì—ëŸ¬ ë©”ì‹œì§€(ê³ ì •): `í•´ë‹¹ ë‚ ì§œ/ì‹œê°„ì€ ì„œë¨¸íƒ€ì„ ì „í™˜ìœ¼ë¡œ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‹œê°„ì„ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.`
- **ì ˆëŒ€ ê¸ˆì§€**: â€œìë™ìœ¼ë¡œ 03:xxë¡œ ë³´ì •â€ (ì‚¬ì£¼ê°€ ë°”ë€œ)

---

## 2) â€œëª¨í˜¸í•œ ì‹œê°„(ë‘ ë²ˆ ì¡´ì¬)â€ ì…ë ¥ ë°©ì–´(ê°•ì œ)

### 2.1 ì •ì˜
DST ì¢…ë£Œì¼ì—ëŠ” 03:00 â†’ 02:00ìœ¼ë¡œ ë˜ëŒì•„ê°€ë©°, **02:00~02:59**ê°€ ë‘ ë²ˆ ì¡´ì¬í•œë‹¤(ëª¨í˜¸í•œ ì‹œê°„). îˆ€citeîˆ‚turn0search5îˆ‚turn0search4îˆ

### 2.2 ê°•ì œ ê·œì¹™
- ì‚¬ìš©ìê°€ ëª¨í˜¸í•œ ì‹œê°„ì„ ì…ë ¥í•˜ë©´:
  - ì‹œìŠ¤í…œì€ ìë™ìœ¼ë¡œ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì§€ ì•ŠëŠ”ë‹¤.
  - ì•„ë˜ ì¤‘ **í•˜ë‚˜ì˜ ì •ì±…ì„ PRDì—ì„œ ê³ ì •**í•´ì•¼ í•œë‹¤(ê°œë°œìê°€ ì„ì˜ ì„ íƒ ê¸ˆì§€):

**ì •ì±… A(ê¶Œì¥: ì‚¬ìš©ì í™•ì¸)**
- UIì— â€œì„œë¨¸íƒ€ì„ ì ìš© ì—¬ë¶€â€ ì„ íƒ(í† ê¸€)ì„ **í•´ë‹¹ ì¼€ì´ìŠ¤ì—ì„œë§Œ** ë…¸ì¶œ
  - `dstPreference: "dst" | "standard"`
- ì„œë²„ëŠ” ì„ íƒê°’ì„ ë°›ì•„ UTC ë³€í™˜ì„ í™•ì •í•œë‹¤.

**ì •ì±… B(ë‹¨ìˆœ ìš´ì˜: í‘œì¤€ì‹œ ìš°ì„ )**
- ëª¨í˜¸í•œ ì‹œê°„ì€ ê¸°ë³¸ì ìœ¼ë¡œ â€œì„œë¨¸íƒ€ì„ ì¢…ë£Œ í›„(í‘œì¤€ì‹œ)â€ë¡œ í•´ì„í•œë‹¤.

> ìœ ë£Œ ë§Œì„¸ë ¥/ì‚¬ì£¼ ì„œë¹„ìŠ¤ëŠ” ì •ì±… Aê°€ ì•ˆì „í•˜ë‹¤. (ë¶„ìŸ ë°©ì§€)

---

## 3) ìë™ ê²€ì¦ ë²¡í„°(í•„ìˆ˜ 5ì¢…)

> ëª©í‘œ: ëŸ°íƒ€ì„/ë°°í¬ í™˜ê²½ì´ ë‹¬ë¼ë„ â€œDST ë°˜ì˜ ì—¬ë¶€â€ë¥¼ ìë™ìœ¼ë¡œ ì¡ì•„ë‚´ê¸°.
> ì´ ë²¡í„°ëŠ” â€œAsia/Seoul ì—­ì‚¬ì  íƒ€ì„ì¡´â€ì´ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦í•œë‹¤.

### V1. DST ê¸°ê°„(1988) â€” KDT(UTC+10)
- ì…ë ¥: `1988-07-01 10:00 Asia/Seoul`
- ê¸°ëŒ€: ì˜¤í”„ì…‹ `UTC+10`, UTC `1988-07-01T00:00:00Z`

### V2. DST ì‹œì‘ ì§ì „(1988) â€” KST(UTC+9)
- ì…ë ¥: `1988-05-08 01:30 Asia/Seoul`
- ê¸°ëŒ€: ì˜¤í”„ì…‹ `UTC+9`, UTC `1988-05-07T16:30:00Z`

### V3. DST ì‹œì‘ â€œì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‹œê°„â€(1988) â€” ê±°ì ˆ
- ì…ë ¥: `1988-05-08 02:30 Asia/Seoul`
- ê¸°ëŒ€: **422** + ê³ ì • ë©”ì‹œì§€(ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‹œê°„)

### V4. DST ì¢…ë£Œ â€œëª¨í˜¸í•œ ì‹œê°„â€(1988) â€” ì‚¬ìš©ì ì„ íƒ í•„ìš”
- ì…ë ¥: `1988-10-09 02:30 Asia/Seoul`
- ê¸°ëŒ€: **ëª¨í˜¸í•¨ ê°ì§€**
  - ì„ íƒ=dst(UTC+10) â†’ UTC `1988-10-08T16:30:00Z`
  - ì„ íƒ=standard(UTC+9) â†’ UTC `1988-10-08T17:30:00Z`

### V5. DST ë¯¸ì‚¬ìš© ì—°ë„(1990) â€” KST(UTC+9)
- ì…ë ¥: `1990-01-01 10:00 Asia/Seoul`
- ê¸°ëŒ€: ì˜¤í”„ì…‹ `UTC+9`, UTC `1990-01-01T01:00:00Z`

---

## 4) í…ŒìŠ¤íŠ¸ êµ¬í˜„ ì§€ì¹¨(í•„ìˆ˜)
- ìµœì†Œ 1ê°œì˜ ìë™ í…ŒìŠ¤íŠ¸ íŒŒì¼ì„ í¬í•¨í•œë‹¤.
- luxon/date-fns-tz ì‚¬ìš© ì‹œ:
  - â€œì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‹œê°„â€ì€ **ì…ë ¥ê°’ê³¼ ìƒì„±ëœ DateTimeì˜ ë¡œì»¬ ì‹œê°ì´ ë™ì¼í•œì§€**ë¡œ ê²€ì¦í•œë‹¤(ìë™ ë³´ì • íƒì§€).
  - â€œëª¨í˜¸í•œ ì‹œê°„â€ì€ **UTCë¥¼ +1h ì´ë™ í›„ ë‹¤ì‹œ Asia/Seoulë¡œ ë³€í™˜í–ˆì„ ë•Œ ë¡œì»¬ ì‹œê°ì´ ë™ì¼í•œì§€**ë¡œ ê°ì§€í•œë‹¤.

---

# ë¶€ë¡: ê³µí†µ ìš´ì˜ ìš”êµ¬ì‚¬í•­(ë°°í¬ ê°€ëŠ¥ ê¸°ì¤€)

- ë²„ì „: v1.1
- ìµœì¢… ì—…ë°ì´íŠ¸: 2025-12-21 (Asia/Seoul)
- ìƒíƒœ: FINAL

# âœ… ë¹„ê¸°ëŠ¥ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­ (Non-Functional Requirements) â€” Saju Service (v1.0)
- ì‘ì„±ì¼: 2025-12-21
- ëª©ì : ê¸°ëŠ¥ êµ¬í˜„ ì™¸ì— **â€œë°°í¬ ê°€ëŠ¥í•œ ìƒíƒœ(Production-Ready)â€**ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ ê³µí†µ ìš”êµ¬ì‚¬í•­ ì²´í¬ë¦¬ìŠ¤íŠ¸
- ì ìš© ë²”ìœ„: PRD1(ë§Œì„¸ë ¥) / PRD2(ì‚¬ì£¼í’€ì´) / PRD3(ì‚¬ì£¼ì±„íŒ…) / /vault / ê²°ì œ / n8n ì—°ë™

---

## ê°œë°œìì—ê²Œ ì „ë‹¬í•  â€œìµœì¢… ì ê²€ìš© í”„ë¡¬í”„íŠ¸â€(ë³µë¶™)
ì•„ë˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ê°œë°œì(ì—ì´ì „íŠ¸)ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.

> ì„œë¹„ìŠ¤ ì¶œì‹œë¥¼ ìœ„í•œ **ë¹„ê¸°ëŠ¥ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­(Non-Functional Requirements)** ë¬¸ì„œë¥¼ ì‘ì„±í•˜ê³ , ì‹¤ì œ ì½”ë“œì— ë°˜ì˜í•´ ì£¼ì„¸ìš”.  
> ì•„ë˜ í•­ëª©ì€ **Common Requirements ë¬¸ì„œ + Global Layout(app/layout.tsx) + ê³µí†µ ì»´í¬ë„ŒíŠ¸(footer/header) + ì¸í”„ë¼ ì„¤ì •**ì— ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.  
> ê° í•­ëª©ì€ â€œë¬´ì—‡ì„ / ì–´ë””ì— / ì–´ë–»ê²Œâ€ êµ¬í˜„í• ì§€ê¹Œì§€ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì²´í¬ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ì™„ë£Œ ì—¬ë¶€ë¥¼ í‘œì‹œí•  ìˆ˜ ìˆê²Œ í•´ ì£¼ì„¸ìš”.

---

## 1) Legal Pages (PG ì‹¬ì‚¬ ëŒ€ë¹„) â€” í•„ìˆ˜
### 1.1 Footer ë§í¬
- Footerì— ë‹¤ìŒ ë§í¬ë¥¼ í•­ìƒ ë…¸ì¶œ:
  - `/terms` ì´ìš©ì•½ê´€
  - `/privacy` ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨

### 1.2 ì •ì  í˜ì´ì§€ êµ¬í˜„
- Next.js App Router ê¸°ì¤€:
  - `app/terms/page.tsx`
  - `app/privacy/page.tsx`
- ë‚´ìš©ì€ **ì •ì  í…ìŠ¤íŠ¸ placeholder**ë¡œ ë¨¼ì € êµ¬ì„±(ì¶”í›„ ì‹¤ì œ ë¬¸êµ¬ë¡œ êµì²´)
- í˜ì´ì§€ í•˜ë‹¨ì— â€œìµœì¢… ìˆ˜ì •ì¼â€ í‘œê¸° ì˜ì—­ í¬í•¨

### 1.3 PG ì‹¬ì‚¬ì—ì„œ ìì£¼ ë³´ëŠ” ì¶”ê°€ ë…¸ì¶œ(ê¶Œì¥)
- Footer ë˜ëŠ” `/terms` ë‚´ë¶€ì— ë‹¤ìŒ placeholder ì˜ì—­ í™•ë³´:
  - ìƒí˜¸/ëŒ€í‘œ/ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸/í†µì‹ íŒë§¤ì—…ì‹ ê³ ë²ˆí˜¸
  - ê³ ê°ì„¼í„° ì—°ë½ì²˜/ì´ë©”ì¼
  - í™˜ë¶ˆ/ì·¨ì†Œ ê·œì • ë§í¬(ì˜ˆ: `/refund`)
> PGì‚¬/í”Œë«í¼ì— ë”°ë¼ ìš”êµ¬ì‚¬í•­ì´ ë‹¬ë¼ì„œ, ìµœì†Œí•œ â€œìë¦¬ë¥¼ í™•ë³´â€í•´ë‘ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.

---

## 2) SEO & Open Graph (ê³µìœ  ìµœì í™”) â€” í•„ìˆ˜
### 2.1 Global Metadata
- `app/layout.tsx`ì—ì„œ global metadata ì„¤ì •:
  - `title`: "ë‹¹ì‹ ì˜ ìš´ëª…ì„ ì½ë‹¤, 000"
  - `description`: "ì •í†µ ë§Œì„¸ë ¥ê³¼ AI ì‚¬ì£¼í’€ì´ë¡œ ë³´ëŠ” ë‚˜ì˜ ìš´ì„¸"
  - `openGraph`:
    - `title`, `description`
    - `images`: `/og-default.png` (public)
  - `twitter`: summary_large_image ì„¤ì •(ê°€ëŠ¥í•˜ë©´)

### 2.2 OG ì´ë¯¸ì§€ íŒŒì¼
- `public/og-default.png` íŒŒì¼ ì¡´ì¬ ë³´ì¥
- (ê¶Œì¥) í˜ì´ì§€ë³„ OG ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ:
  - ë§Œì„¸ë ¥ ê²°ê³¼/ë¦¬í¬íŠ¸ ê²°ê³¼ í˜ì´ì§€ëŠ” â€œê°œì¸ì •ë³´ í¬í•¨ ê¸ˆì§€â€  
  - ì¦‰, **ê³µìœ ìš© OGëŠ” ê¸°ë³¸ê°’ ê³ ì •**ì´ ì•ˆì „

### 2.3 Robots/Index ì •ì±…(í•„ìˆ˜)
- ë¯¼ê° í˜ì´ì§€(ë¦¬í¬íŠ¸/ì±„íŒ…/ë³´ê´€í•¨)ëŠ” noindex ê¶Œì¥
  - `/vault/**`, `/chat/**`, `/report/**` ë“±
- `robots.txt` ë˜ëŠ” metadataì—ì„œ í˜ì´ì§€ë³„ ì œì–´

---

## 3) Error Monitoring (Sentry) â€” í•„ìˆ˜
### 3.1 Sentry SDK ì—°ë™ ë²”ìœ„
- Next.jsì—ì„œ Client/Server ëª¨ë‘ ìˆ˜ì§‘ë˜ë„ë¡ ì„¤ì •
  - ë¸Œë¼ìš°ì € ì—ëŸ¬ + ì„œë²„ ì—ëŸ¬ + API route ì—ëŸ¬ + edge/ì„œë²„ë¦¬ìŠ¤ ëŸ°íƒ€ì„ ì—ëŸ¬

### 3.2 ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹(í•„ìˆ˜)
- ë‹¤ìŒ ë°ì´í„°ëŠ” Sentry ì´ë²¤íŠ¸ì—ì„œ ë§ˆìŠ¤í‚¹/ì œì™¸:
  - ìƒë…„ì›”ì¼/ì¶œìƒì‹œê°„/ì¶œìƒì§€(ì°¨íŠ¸ input_json)
  - ì±„íŒ… ë³¸ë¬¸(content)
  - ê²°ì œ ì‹ë³„ì •ë³´ ì¼ë¶€(ì „ì²´ ì¹´ë“œ/PG ë¯¼ê°ì •ë³´)
- â€œì‚¬ìš©ì ì‹ë³„â€ì€ user_id ì •ë„ë§Œ(í•„ìš” ì‹œ í•´ì‹œ)

### 3.3 ë¦´ë¦¬ì¦ˆ íƒœê·¸/í™˜ê²½ ë¶„ë¦¬(í•„ìˆ˜)
- env: `development` / `staging` / `production` êµ¬ë¶„
- release ë²„ì „(ì»¤ë°‹ í•´ì‹œ ë˜ëŠ” ë°°í¬ ë²„ì „) íƒœê¹…

---

## 4) Support Channel â€” í•„ìˆ˜
### 4.1 ê³ ê°ì„¼í„° ë…¸ì¶œ
- Footerì— ê³ ê°ì„¼í„° ì´ë©”ì¼ì„ mailtoë¡œ ë…¸ì¶œ:
  - `support@YOUR_DOMAIN`
- (ê¶Œì¥) ìš´ì˜ì‹œê°„/ì‘ë‹µ SLA ë¬¸êµ¬ placeholder

### 4.2 í”¼ë“œë°± ìœ„ì ¯(ì„ íƒ)
- Channel.io ë˜ëŠ” Tally ë“±:
  - ìŠ¤í¬ë¦½íŠ¸ ì‚½ì… ì˜ì—­ì„ layoutì— í™•ë³´
  - í™˜ê²½ë³€ìˆ˜ë¡œ on/off ê°€ëŠ¥(Feature Flag)

---

## 5) Security & Abuse ë°©ì–´ â€” â€œë°°í¬ ê°€ëŠ¥â€ì˜ í•µì‹¬
## 5.x í™˜ê²½ë³€ìˆ˜ í…œí”Œë¦¿(.env.example) â€” í•„ìˆ˜(ì—´ì‡  ê¾¸ëŸ¬ë¯¸)
### 5.x.1 .env.example ê°•ì œ
- í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `.env.example` íŒŒì¼ì„ **í•„ìˆ˜ í¬í•¨**í•œë‹¤.
- ì‹¤ì œ í‚¤ ê°’ì€ ë¹„ì›Œë‘ë˜, í•„ìš”í•œ ëª¨ë“  Key ëª…ì¹­ê³¼ ìš©ë„ë¥¼ ì£¼ì„ìœ¼ë¡œ ëª…ì‹œí•œë‹¤.

### 5.x.2 ìµœì†Œ í¬í•¨ í‚¤ ëª©ë¡(ì˜ˆì‹œ)
- Supabase
  - `NEXT_PUBLIC_SUPABASE_URL=`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY=`
  - `SUPABASE_SERVICE_ROLE_KEY=`
- n8n (Gateway â†’ n8n)
  - `N8N_WEBHOOK_URL=`
  - `N8N_API_KEY=`
- ê²°ì œ(Toss ì˜ˆì‹œ)
  - `TOSS_SECRET_KEY=`
  - `TOSS_CLIENT_KEY=`
  - `TOSS_WEBHOOK_SECRET=`
- Sentry
  - `SENTRY_DSN=`
- Swiss Ephemeris(wasm) / Ephemeris íŒŒì¼ ê²½ë¡œ
  - `SE_EPHE_PATH=public/ephe`
- ìš´ì˜
  - `APP_BASE_URL=` (ì˜ˆ: https://yourdomain.com)
  - `SUPPORT_EMAIL=` (ì˜ˆ: support@yourdomain.com)

> ì›ì¹™: â€œí‚¤ê°€ ì—†ìœ¼ë©´ ë¹Œë“œ/ì„œë²„ ë¶€íŒ… ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨â€í•˜ë„ë¡ ì²´í¬ë¥¼ ë‘”ë‹¤(ë°°í¬ ì‚¬ê³  ë°©ì§€).

### 5.1 ì¸ì¦/ê¶Œí•œ ê²½ê³„(í•„ìˆ˜)
- ì •ì±… ê³ ì •:
  - í´ë¼ì´ì–¸íŠ¸ â†’ n8n ì§ê²° ê¸ˆì§€
  - Next.js Gatewayì—ì„œë§Œ n8n í˜¸ì¶œ
  - ìœ ë£Œ ì„¹ì…˜ í•„í„°ë§/tier íŒì •ì€ Next.js ì„œë²„ê°€ ì§„ì‹¤

### 5.2 Rate Limit / Bot ë°©ì–´(í•„ìˆ˜)
- ìµœì†Œ ì ìš© ëŒ€ìƒ:
  - `/api/mansaeryeok/calc`
  - `/api/interpretation/report`
  - `/api/chat/*` (ìƒë‹´)
- ê¸°ì¤€ ì˜ˆì‹œ:
  - IP ê¸°ë°˜ + ì‚¬ìš©ì ê¸°ë°˜ í˜¼í•©
  - 1ë¶„ë‹¹ NíšŒ, ì´ˆê³¼ ì‹œ 429
- (ê¶Œì¥) reCAPTCHA/Turnstileì€ â€œê²°ì œ/íšŒì›ê°€ì…â€ì—ë§Œ ìµœì†Œ ì ìš©

### 5.3 Idempotency (í•„ìˆ˜)
- ê²°ì œ í›„/ë¦¬í¬íŠ¸ ìƒì„±/ì±„íŒ… ì°¨ê°ì€ ë©±ë“± ë³´ì¥:
  - chat_messages `(owner_id, idempotency_key)` unique
  - credit_logs `(entitlement_id, reason, related_ref_id)` unique
  - report ìƒì„±ì€ â€œBound+exists=returnâ€ ë™ì‘

---

## 6) Observability / ìš´ì˜ ë¡œê·¸ â€” í•„ìˆ˜
### 6.1 ì„œë²„ ë¡œê·¸ í‘œì¤€(í•„ìˆ˜)
- ëª¨ë“  API ì‘ë‹µì— `request_id` í¬í•¨(ë¡œê·¸ì—ë„ ë™ì¼ ê°’)
- í•„ìˆ˜ ë¡œê·¸ í•„ë“œ:
  - request_id, user_id(optional), route, status_code, latency_ms, error_code(optional)

### 6.2 n8n ì—°ë™ ë¡œê·¸(í•„ìˆ˜)
- n8n í˜¸ì¶œ ì‹œ:
  - workflow_name, run_id, cache_hit ì—¬ë¶€, llm_called ì—¬ë¶€, tokens_estimate(optional)

---

## 7) Data & Backups â€” í•„ìˆ˜
## 7.x ì´ˆê¸° ë°ì´í„° ì‹œë”©(Seeding) â€” í•„ìˆ˜(ìš´ì˜ ì¤€ë¹„ë¬¼)
### 7.x.1 Seed Script ê°•ì œ
- DB ìŠ¤í‚¤ë§ˆ ìƒì„± í›„, ì„œë¹„ìŠ¤ êµ¬ë™ì— í•„ìš”í•œ **í•„ìˆ˜ ë°ì´í„°(ì‚¬ì£¼ í•´ì„ í…ìŠ¤íŠ¸/ë¡œì§ ìƒìˆ˜ ë“±)**ë¥¼ ìë™ ì ì¬í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë°˜ë“œì‹œ ì œê³µí•œë‹¤.
- ì‹¤í–‰ ë°©ì‹(ê³ ì •):
  - `npm run seed`
- ì›ë³¸ ë°ì´í„°:
  - ì œê³µëœ CSV/TXT íŒŒì¼(ì˜ˆ: `@ì‚¼ì†¡ì‚¬ì£¼_í†µí•©_ì •ë¦¬ë³¸.csv`, `@1_8_í†µí•©ìë£Œ.txt` ë“±)ì„ íŒŒì‹±í•˜ì—¬ DBì— INSERT/UPSERT
- ìš”êµ¬ì‚¬í•­:
  - **ë©±ë“±ì„±**: seedë¥¼ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•´ë„ ì¤‘ë³µ ì ì¬/ë°ì´í„° í­ë°œì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ `logic_key` ê¸°ë°˜ upsertë¥¼ ë³´ì¥í•œë‹¤.
  - **ê²€ì¦**: ì ì¬ í›„ ë ˆì½”ë“œ ìˆ˜/í•„ìˆ˜ logic_key ì¡´ì¬ ì—¬ë¶€ë¥¼ ê²€ì‚¬í•˜ê³  ì‹¤íŒ¨ ì‹œ ë¹„ì •ìƒ ì¢…ë£Œ(exit 1)
  - **ëŒ€ëŸ‰ ì ì¬**: 1íšŒ ì ì¬ëŸ‰ì´ ì»¤ë„ íƒ€ì„ì•„ì›ƒ/ë©”ëª¨ë¦¬ í­ë°œ ì—†ì´ ë°°ì¹˜ ì²˜ë¦¬(Chunking)

### 7.1 DB ë°±ì—… ì •ì±…(í•„ìˆ˜)
- Supabase/Postgres:
  - ìë™ ë°±ì—… ì£¼ê¸° í™•ì¸ + ë³µêµ¬ ì ˆì°¨ ë¬¸ì„œí™”
- ìµœì†Œ ìš”êµ¬:
  - â€œì‹¤ìˆ˜ë¡œ ì‚­ì œ/ë§ˆì´ê·¸ë ˆì´ì…˜ ì‚¬ê³ â€ ì‹œ ë³µêµ¬ ê°€ëŠ¥í•´ì•¼ í•¨

### 7.2 ë§ˆì´ê·¸ë ˆì´ì…˜ ì›ì¹™(í•„ìˆ˜)
- productionì—ì„œ ìˆ˜ë™ SQL ì‹¤í–‰ ê¸ˆì§€(ì›ì¹™)
- migrations íŒŒì¼ë¡œë§Œ ë°°í¬
- ë¡¤ë°± ì „ëµ(ìµœì†Œ):
  - ì´ì „ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤ëƒ…ìƒ·/íƒœê·¸ ìœ ì§€

---

## 8) Performance & Cost Control â€” í•„ìˆ˜
### 8.1 ìºì‹œ/ìš”ì•½/ì˜ˆì‚° ê·œì¹™ ì§‘í–‰(í•„ìˆ˜)
- ìºì‹œ hitë©´ LLM í˜¸ì¶œ 0íšŒ
- ì»¨í…ìŠ¤íŠ¸ ì˜ˆì‚° ì´ˆê³¼ ì‹œ:
  - ì›ë¬¸ ë” ë¶™ì´ì§€ ì•Šê³  ìš”ì•½ ëŒ€ì²´
- ìš”ì•½ ì‹¤íŒ¨ 3íšŒ ì—°ì†:
  - text_only ëª¨ë“œ ê°•ì œ + structured ìš”ì•½ì€ í”„ë¡¬í”„íŠ¸ì—ì„œ ì œê±°(Null/'')

### 8.2 ì´ë¯¸ì§€/ì •ì  ìì‚° ìµœì í™”(ê¶Œì¥)
- OG ì´ë¯¸ì§€/ì•„ì´ì½˜/í°íŠ¸ ìš©ëŸ‰ í™•ì¸
- (ê¶Œì¥) next/image ì‚¬ìš©

---

## 9) Accessibility & UX ì•ˆì •ì„± â€” ê¶Œì¥(í•˜ì§€ë§Œ í˜„ì‹¤ì ìœ¼ë¡œ ì¤‘ìš”)
- ê¸°ë³¸ í‚¤ë³´ë“œ ì ‘ê·¼ ê°€ëŠ¥
- í¼ ì—ëŸ¬ ë©”ì‹œì§€ ëª…í™•(íŠ¹íˆ ìƒë…„ì›”ì¼/ì‹œê°„ëª¨ë¦„)
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„ UX ì œê³µ

---

## 10) Analytics / KPI â€” ê¶Œì¥(ìš´ì˜ í•„ìˆ˜)
- GA4 ë˜ëŠ” PostHog(ì„ íƒ)
- ìµœì†Œ ì´ë²¤íŠ¸:
  - ë§Œì„¸ë ¥ ê³„ì‚° ì„±ê³µ
  - íšŒì›ê°€ì…
  - ë¦¬í¬íŠ¸ ê²°ì œ ì§„ì…/ì™„ë£Œ
  - ë¦¬í¬íŠ¸ ìƒì„± ì„±ê³µ
  - ìƒë‹´ ì‹œì‘/ì°¨ê° ë°œìƒ
- ê°œì¸ì •ë³´ í¬í•¨ ì´ë²¤íŠ¸ ê¸ˆì§€(ì°¨íŠ¸ input ê°’ ê·¸ëŒ€ë¡œ ë³´ë‚´ì§€ ë§ ê²ƒ)

---

## 11) Release & Environment â€” í•„ìˆ˜
### 11.1 í™˜ê²½ë³€ìˆ˜ ì²´í¬(í•„ìˆ˜)
- `.env.example` ì œê³µ
- ëˆ„ë½ ì‹œ ì„œë²„ ë¶€íŒ…/ë¹Œë“œ ì‹¤íŒ¨í•˜ë„ë¡ ì²´í¬(ê¶Œì¥)

### 11.2 Staging í™˜ê²½(ê¶Œì¥)
- PG/ê²°ì œëŠ” í…ŒìŠ¤íŠ¸ ëª¨ë“œ ë¶„ë¦¬
- Sentryë„ staging ë¶„ë¦¬

---

## 12) â€œë°°í¬ ê°€ëŠ¥â€ ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸(ê²°ë¡ )
- [ ] `/terms`, `/privacy` ì¡´ì¬ + Footer ë§í¬ ë…¸ì¶œ
- [ ] Global metadata + `public/og-default.png` ì¡´ì¬
- [ ] Sentry client/server ì—°ë™ + ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹
- [ ] support mailto ë…¸ì¶œ
- [ ] Rate limit ì ìš©(í•µì‹¬ API)
- [ ] Idempotency ì œì•½(DB unique) ì ìš©
- [ ] DB ë°±ì—…/ë³µêµ¬ ì ˆì°¨ ë¬¸ì„œí™”
- [ ] ìš´ì˜ ë¡œê·¸(request_id) í‘œì¤€ ì ìš©
- [ ] n8n ìºì‹œ/ìš”ì•½/ë¹„ìƒëª¨ë“œ ê·œì¹™ ì§‘í–‰ í™•ì¸
- [ ] `npm run seed` ì œê³µ + seed ë©±ë“±/ê²€ì¦ í¬í•¨
- [ ] `.env.example` ì œê³µ(ëª¨ë“  í‚¤ ëª…ì‹œ, ê°’ì€ ë¹„ì›€)

# ë¶€ë¡: ìµœì¢… DB ìŠ¤í‚¤ë§ˆ ë§¤í•‘(Source of Truth)

- ë²„ì „: v1.1
- ìµœì¢… ì—…ë°ì´íŠ¸: 2025-12-21 (Asia/Seoul)
- ìƒíƒœ: FINAL

# ğŸ“‚ [Final] Saju Service DB Schema Mapping (Source of Truth) â€” v1.1 (QA Patch)
- ì‘ì„±ì¼: 2025-12-21
- ëª©ì : PRD1/2/3 + ê¸°ëŠ¥ëª…ì„¸ì„œì˜ ìš”êµ¬ì‚¬í•­ì„ **DB ìŠ¤í‚¤ë§ˆ/ì œì•½/ì¸ë±ìŠ¤ ìˆ˜ì¤€ì—ì„œ ê°•ì œ**í•˜ê¸° ìœ„í•œ ìµœì¢… ë§¤í•‘ ë¬¸ì„œ
- ì›ì¹™: ì´ ë¬¸ì„œì™€ ì¶©ëŒí•˜ëŠ” êµ¬í˜„ì€ ë²„ê·¸ë¡œ ê°„ì£¼í•œë‹¤.

---

## 0. ë¨¼ì € ê²°ë¡ (ë„ˆ ë¬¸ì„œì˜ ìˆ˜ì •/ë³´ê°• í¬ì¸íŠ¸)
ë„ˆê°€ ì‘ì„±í•œ ë°©í–¥(ê²°ì œ=ê¶Œí•œ=ì°¨íŠ¸ 1ê°œ ë°”ì¸ë”©, Ledger)ì€ ë§ë‹¤.  
ë‹¤ë§Œ ì•„ë˜ 5ê°œê°€ ë¹ ì§€ë©´ ì‹¤ì œ ìš´ì˜ì—ì„œ í„°ì§„ë‹¤(ê³ ê°ì„¼í„° í­ì£¼ ë ˆë²¨):

1) **`chat_messages` í…Œì´ë¸”ì´ ì—†ìŒ** â†’ ë©±ë“± ì €ì¥/ì°¨ê° ì›ìí™”ê°€ êµ¬í˜„ ë¶ˆê°€  
2) **Entitlementâ†”Chart 1:1 ê°•ì œ ì œì•½ì´ ì—†ìŒ** â†’ í•˜ë‚˜ì˜ ì°¨íŠ¸ë¥¼ ì—¬ëŸ¬ ê²°ì œê°€ ì¡ëŠ” ì‚¬ê³   
3) **Credit Ledger ì¤‘ë³µ ì°¨ê° ë°©ì§€ ìœ ë‹ˆí¬ê°€ ì—†ìŒ** â†’ ì¬ì‹œë„/íƒ€ì„ì•„ì›ƒ ì‹œ -2, -3 ì°¨ê°  
4) **ë¦¬í¬íŠ¸ ìŠ¤ëƒ…ìƒ·/ì¬ìƒì„±(Revision) í•„ë“œê°€ ì—†ìŒ** â†’ â€œì—…ì„œíŠ¸ë¡œ ë®ì–´ì“°ê¸°â€ ì‚¬ê³  ì¬ë°œ  
5) **ì‚­ì œ ë°©ì§€(LOCK A) DB ë ˆë²¨ ê°•ì œê°€ ì•½í•¨** â†’ locked ì°¨íŠ¸ ì‚­ì œ ì‹œë„ì—ì„œ ê¹¨ì§„ ìƒíƒœ ê°€ëŠ¥

ì´ v1.1ì—ì„œ ìœ„ 5ê°œë¥¼ â€œDBì—ì„œ ëª»í•˜ê²Œâ€ ë³´ê°•í–ˆë‹¤.

---

## 1. í•µì‹¬ ì •ì±… ìš”ì•½(ê°•ì œ)
1. **1 Payment = 1 Entitlement**  
2. **Entitlement â†” Chart (1:1 ë°”ì¸ë”©)**  
3. **Ledger System**: ìƒë‹´ í¬ë ˆë”§ ì¶©ì „/ì°¨ê°ì€ ë°˜ë“œì‹œ `credit_logs`ì— ê¸°ë¡  
4. **Lock A**: ìœ ë£Œ ë¦¬í¬íŠ¸ì— ì‚¬ìš©ëœ(locked) ì°¨íŠ¸ëŠ” ì‚­ì œ ë¶ˆê°€(ìˆ¨ê¹€ë§Œ)  
5. **Lock B**: ë¦¬í¬íŠ¸ ìƒì„±ì€ ë©±ë“±ì´ë©°, Bound ìƒíƒœì—ì„œ ì‹¤íŒ¨í•´ë„ â€œë¬´ë£Œ ë³µêµ¬â€ ê°€ëŠ¥  
6. **Chat Gate**: ìƒë‹´ì€ ë¦¬í¬íŠ¸(ì‚¬ì£¼í’€ì´) ì´í›„ì—ë§Œ ê°€ëŠ¥  
7. **Deduct Rule**: assistant ë©”ì‹œì§€ ì €ì¥ ì„±ê³µ 1íšŒ = 1ì°¨ê°(ì €ì¥ ì‹¤íŒ¨ëŠ” 0ì°¨ê°)

---

## 2. í…Œì´ë¸” ìƒì„¸ ë§¤í•‘

### â‘  `saju_charts` (ë§Œì„¸ë ¥/ì°¨íŠ¸ ë°ì´í„°)
> ì—­í• : ë§Œì„¸ë ¥ ê³„ì‚° ê²°ê³¼ ì €ì¥ì†Œ (**íšŒì› ì €ì¥ O / ê²ŒìŠ¤íŠ¸ DB ì €ì¥ X**)

**ì»¬ëŸ¼**
- `id` (UUID, PK)
- `owner_id` (UUID, NOT NULL) â€” **ê²ŒìŠ¤íŠ¸ ì €ì¥ X ì •ì±…ì´ë¯€ë¡œ NOT NULLì´ ì•ˆì „**
- `input_json` (JSONB, NOT NULL)
- `result_json` (JSONB, NOT NULL) â€” ì‹œê°„ëª¨ë¦„ì´ë©´ ì‹œì£¼ ê´€ë ¨ í•„ë“œëŠ” null/unknown ìœ ì§€
- `is_locked` (Boolean, NOT NULL, Default false) â€” ìœ ë£Œ ë¦¬í¬íŠ¸ ë°”ì¸ë”© ì‹œ true
- `name` (Text, NULL) â€” ì‚¬ìš©ìê°€ ë¶™ì¸ ì´ë¦„ (ì˜ˆ: â€œìš°ë¦¬ ë‚¨í¸â€)
- `is_hidden` (Boolean, NOT NULL, Default false) â€” **ì‚­ì œ ëŒ€ì‹  ìˆ¨ê¹€**
- `created_at`, `updated_at` (Timestamptz)

**ì œì•½/ì¸ë±ìŠ¤(í•„ìˆ˜)**
- (ê¶Œì¥) `UNIQUE (owner_id, name)` â€” ì´ë¦„ ì¤‘ë³µ ë°©ì§€(ì„ íƒ)
- `INDEX (owner_id, created_at DESC)`
- `INDEX (owner_id, is_hidden, created_at DESC)`

**ì‚­ì œ ì •ì±…(ê°•ì œ)**
- í”„ë¡ íŠ¸ì—ì„œ â€œì‚­ì œâ€ ë²„íŠ¼ì€ locked ì°¨íŠ¸ì— ë…¸ì¶œ ê¸ˆì§€
- ì„œë²„ëŠ” ì‚­ì œ ìš”ì²­ ì‹œ:
  - `is_locked=true`ë©´ 403/409ë¡œ ê±°ì ˆ + ê³ ì • ë©”ì‹œì§€ â€œì‚­ì œ ë¶ˆê°€: ìˆ¨ê¹€ ì²˜ë¦¬ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.â€
- DBì—ì„œë„ `interpretation_reports.chart_id` FKê°€ `RESTRICT`ë¼ ì‹¤ì‚­ì œê°€ ë§‰íŒë‹¤(ì•„ë˜ ì°¸ê³ )

---

### â‘¡ `entitlements` (êµ¬ë§¤ ê¶Œí•œ/ì´ìš©ê¶Œ)
> ì—­í• : â€œë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ê°€â€ë¥¼ ì •ì˜í•˜ëŠ” í‹°ì¼“(ê²°ì œ 1ê±´=1ê°œ)

**ì»¬ëŸ¼**
- `id` (UUID, PK)
- `owner_id` (UUID, NOT NULL)
- `product_type` (Text, NOT NULL)
  - `interpretation_only` | `interpretation_chat_pack` | `chat_addon`(ì¶”ê°€ìƒë‹´)
- `status` (Text, NOT NULL)
  - `unbound` | `bound` | `refunded`(ì„ íƒ) | `canceled`(ì„ íƒ)
- `bound_chart_id` (UUID, NULL, FK -> `saju_charts.id`)
- `linked_payment_id` (Text, NOT NULL) â€” ì£¼ë¬¸ë²ˆí˜¸/ê²°ì œ íŠ¸ëœì­ì…˜ ì¶”ì 
- `parent_entitlement_id` (UUID, NULL, FK -> entitlements.id) â€” **chat_addonì´ ì–´ë–¤ base entitlementì— ë¶™ëŠ”ì§€**
- `created_at` (Timestamptz)

**ì œì•½/ì¸ë±ìŠ¤(í•„ìˆ˜)**
- **Entitlementâ†”Chart 1:1 ê°•ì œ**
  - `UNIQUE (bound_chart_id) WHERE bound_chart_id IS NOT NULL`
  - ì˜ë¯¸: í•œ ì°¨íŠ¸ëŠ” ë‹¨ í•˜ë‚˜ì˜ entitlementì—ë§Œ ë°”ì¸ë”© ê°€ëŠ¥(ì •ì±… 2 ê°•ì œ)
- `INDEX (owner_id, created_at DESC)`
- `INDEX (linked_payment_id)`

**ë¹„ê³ **
- â€œíŒ¨í‚¤ì§€(ë¦¬í¬íŠ¸+ìƒë‹´)â€ëŠ” entitlement 1ê°œë¡œ ì¶©ë¶„í•˜ë‹¤.
- â€œì¶”ê°€ ìƒë‹´â€ì€ `chat_addon` entitlementë¥¼ ë§Œë“¤ê³  `parent_entitlement_id`ë¡œ baseì— ë¬¶ëŠ”ë‹¤.

---

### â‘¢ `interpretation_reports` (ì‚¬ì£¼í’€ì´ ê²°ê³¼)
> ì—­í• : í™•ì •ëœ entitlementë¡œ ìƒì„±ëœ ë¦¬í¬íŠ¸ **ìŠ¤ëƒ…ìƒ·(ë¶ˆë³€)**

**ì»¬ëŸ¼**
- `id` (UUID, PK)
- `entitlement_id` (UUID, NOT NULL, FK -> `entitlements.id`)
- `chart_id` (UUID, NOT NULL, FK -> `saju_charts.id`)
- `payload_json` (JSONB, NOT NULL) â€” **ìŠ¤ëƒ…ìƒ·**
- `tier` (Text, NOT NULL) â€” `basic` | `premium`
- `report_revision` (Int, NOT NULL, Default 1) â€” ì¬ìƒì„± ì‹œ +1
- `engine_version` (Text, NOT NULL) â€” ì•Œê³ ë¦¬ì¦˜ ë²„ì „ ê¸°ë¡(ì˜ˆ: â€œinterp-v3.2â€)
- `is_current` (Boolean, NOT NULL, Default true) â€” ìµœì‹  ë¦¬ë¹„ì „ í‘œì‹œ
- `created_at` (Timestamptz)

**FK ì˜µì…˜(LOCK A í•µì‹¬)**
- `chart_id` FKëŠ” ë°˜ë“œì‹œ **ON DELETE RESTRICT** (CASCADE ê¸ˆì§€)

**ì œì•½/ì¸ë±ìŠ¤(í•„ìˆ˜)**
- `UNIQUE (entitlement_id, report_revision)`
- `INDEX (chart_id)`
- `INDEX (entitlement_id, is_current)`

**ìŠ¤ëƒ…ìƒ· ë¶ˆë³€ì„±(ê°•ì œ)**
- ê¸°ë³¸ ì¡°íšŒëŠ” `is_current=true` ë¦¬í¬íŠ¸ ë°˜í™˜
- ìë™ ì—…ì„œíŠ¸ë¡œ ë®ì–´ì“°ê¸° ê¸ˆì§€
- ì¬ìƒì„±ì€ â€œìƒˆ row ìƒì„± + ì´ì „ is_current=falseâ€ë¡œ ì²˜ë¦¬

---

### â‘£ `chat_sessions` (ìƒë‹´ ì±„íŒ…ë°©)
> ì—­í• : ìƒë‹´ ëŒ€í™”ì˜ ì»¨í…ìŠ¤íŠ¸ ë‹¨ìœ„  
> **ì¤‘ìš”:** ìƒë‹´ì€ ë°˜ë“œì‹œ â€œë¦¬í¬íŠ¸ ê¸°ë°˜â€ì´ì–´ì•¼ í•œë‹¤.

**ì»¬ëŸ¼**
- `id` (UUID, PK)
- `owner_id` (UUID, NOT NULL)
- `entitlement_id` (UUID, NOT NULL, FK -> entitlements.id)
- `report_id` (UUID, NOT NULL, FK -> interpretation_reports.id) â€” **ìƒë‹´ anchorë¥¼ ëª…ì‹œ**
- `summary_mode` (Text, NOT NULL) â€” `structured` | `text_only`
- `session_summary_structured` (JSONB, NULL)
- `session_summary_text` (Text, NULL)
- `summary_fail_streak` (Int, NOT NULL, Default 0)
- `created_at`, `updated_at` (Timestamptz)

**ì¸ë±ìŠ¤(í•„ìˆ˜)**
- `INDEX (owner_id, updated_at DESC)`
- `INDEX (report_id)`

---

### â‘¤ `chat_messages` (ìƒë‹´ ë©”ì‹œì§€)
> ì—­í• : ë©±ë“± ì €ì¥/ì°¨ê° ì›ìí™”ë¥¼ ìœ„í•œ **source of truth**

**ì»¬ëŸ¼**
- `id` (UUID, PK)
- `session_id` (UUID, NOT NULL, FK -> chat_sessions.id)
- `owner_id` (UUID, NOT NULL)
- `role` (Text, NOT NULL) â€” `user` | `assistant` | `system`
- `content` (Text, NOT NULL)
- `idempotency_key` (Text, NOT NULL) â€” í´ë¼ì´ì–¸íŠ¸/ê²Œì´íŠ¸ì›¨ì´ê°€ ìƒì„±
- `created_at` (Timestamptz)

**ì œì•½(í•„ìˆ˜)**
- **ìœ ë‹ˆí¬:** `UNIQUE (owner_id, idempotency_key)`

**ì¸ë±ìŠ¤**
- `INDEX (session_id, created_at ASC)`

---

### â‘¥ `credit_logs` (ìƒë‹´ í¬ë ˆë”§ ì¥ë¶€ - Ledger) â˜… ì¤‘ìš”
> ì—­í• : í¬ë ˆë”§ì˜ ëª¨ë“  ì¶©ì „/ì‚¬ìš© ì´ë ¥

**ì»¬ëŸ¼**
- `id` (UUID, PK)
- `owner_id` (UUID, NOT NULL)
- `entitlement_id` (UUID, NOT NULL, FK -> entitlements.id)
- `amount` (Int, NOT NULL) â€” +ì¶©ì „ / -ì°¨ê°
- `reason` (Text, NOT NULL)
  - `initial_pack` | `chat_deduct` | `addon_purchase` | `admin_adjust`(ì„ íƒ)
- `related_ref_id` (Text, NOT NULL)
  - ê²°ì œ ID ë˜ëŠ” `chat_messages.id`(assistant message id ê¶Œì¥)
- `created_at` (Timestamptz)

**ì¤‘ë³µ ì°¨ê° ë°©ì§€(í•„ìˆ˜)**
- `UNIQUE (entitlement_id, reason, related_ref_id)`

**ì”ì•¡ ì¡°íšŒ(ê·œê²©)**
- Source of truth:
  - `SELECT COALESCE(SUM(amount),0) FROM credit_logs WHERE entitlement_id=?`
- ì„±ëŠ¥ ìµœì í™”(ì„ íƒ):
  - `entitlements.cached_balance` + íŠ¸ë¦¬ê±°/ì •ê¸° ë¦¬ë¹Œë“œ
  - ë‹¨, cached_balanceëŠ” â€œìºì‹œâ€ì¼ ë¿ì´ë©° ë¶„ìŸ ì‹œ credit_logs í•©ì´ ì§„ì‹¤

---

## 3. â€œê¶Œí•œ í™•ì • ì²˜ë¦¬â€ë¥¼ DB ê´€ì ì—ì„œ ëª» ë°•ê¸°(í•„ìˆ˜)
ê¶Œí•œ í™•ì • = **entitlements.bound_chart_id ê¸°ë¡ + saju_charts.is_locked=true**ë¥¼ í•œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬.

- ê¶Œì¥ RPC(ê°œë…):
  - `confirm_entitlement_and_lock_chart(entitlement_id, chart_id, idempotency_key)`
- ê·œì¹™:
  - ì´ë¯¸ boundì¸ë° ê°™ì€ chartë©´ OK(ë©±ë“±)
  - ì´ë¯¸ boundì¸ë° ë‹¤ë¥¸ chartë©´ 409(ë¶ˆì¼ì¹˜)

---

## 4. Lock B(ë¦¬í¬íŠ¸ ìƒì„± ë©±ë“±) â€” DBê°€ ë„ì™€ì¤˜ì•¼ í•˜ëŠ” ë¶€ë¶„
- bound + current report ì¡´ì¬ â†’ ê¸°ì¡´ ë°˜í™˜
- bound + report ì—†ìŒ â†’ ë¬´ë£Œ ìƒì„± ì¬ì‹œë„
- unbound â†’ (bound+lock+create) ì›ì íŠ¸ëœì­ì…˜

ê¶Œì¥:
- `interpretation_reports` revision ëª¨ë¸ ì±„íƒ(ì—…ì„œíŠ¸ ê¸ˆì§€)

---

## 5. ìµœì†Œ ê¶Œì¥ ì¶”ê°€ í…Œì´ë¸”(ì„ íƒ)
- `orders`/`payments` (í™˜ë¶ˆ/ìƒíƒœ ë™ê¸°í™”ê°€ í•„ìš”í•˜ë©´ í•„ìˆ˜ë¡œ ìŠ¹ê²©)
- `entitlement_events`(ê°ì‚¬ ë¡œê·¸)

---

## 6. ê°œë°œì ì²´í¬ë¦¬ìŠ¤íŠ¸(í•„ìˆ˜)
- [ ] `chat_messages` ì¡´ì¬ + `UNIQUE(owner_id, idempotency_key)`
- [ ] `credit_logs` `UNIQUE(entitlement_id, reason, related_ref_id)`
- [ ] `entitlements` `UNIQUE(bound_chart_id) WHERE NOT NULL`
- [ ] `interpretation_reports.chart_id` FK: **ON DELETE RESTRICT**
- [ ] ë¦¬í¬íŠ¸ëŠ” upsert ê¸ˆì§€, revision row ìƒì„±
- [ ] locked ì°¨íŠ¸ ì‚­ì œ ê¸ˆì§€, ìˆ¨ê¹€ë§Œ

# ë¶€ë¡: Seed Data ETL ë§¤í•‘ ê·œê²©

- ë²„ì „: v1.0
- ìµœì¢… ì—…ë°ì´íŠ¸: 2025-12-21 (Asia/Seoul)
- ìƒíƒœ: FINAL

# ğŸ“‚ [Final] Seed Data ETL Mapping Specification (v1.0)
- ëª©ì : ì—…ë¡œë“œëœ Raw Data(CSV/TXT)ë¥¼ ì„œë¹„ìŠ¤ DBì— **ì•ˆì „í•˜ê²Œ ì ì¬(Seed)**í•˜ê¸° ìœ„í•œ â€œíŒŒì‹±/ë§¤í•‘ ê·œê²©(ë ˆì‹œí”¼)â€
- ëŒ€ìƒ: `seed.ts`(ë˜ëŠ” `scripts/seed.ts`)ë¥¼ êµ¬í˜„í•˜ëŠ” ê°œë°œì/ì—ì´ì „íŠ¸
- í•µì‹¬ ì›ì¹™: **ê³ ë¯¼ ì—†ì´ ì´ ë¬¸ì„œëŒ€ë¡œë§Œ íŒŒì‹±í•˜ë©´ DBê°€ ì—‰í‚¤ì§€ ì•Šê²Œ ë§Œë“ ë‹¤.**

---

## 0) ì´ˆë³´ì ë²„ì „ ì„¤ëª… (ì´ì‚¬ì§ ì„¼í„° ì§€ì‹œì„œ)
- CSV/TXT íŒŒì¼ = ì´ì‚¿ì§ ë°•ìŠ¤
- DB í…Œì´ë¸” = ìƒˆì§‘ì˜ ë°©/ê°€êµ¬
- ì´ ë¬¸ì„œ = â€œë°•ìŠ¤ AëŠ” ê±°ì‹¤ ì±…ì¥ 1ì¹¸, ë°•ìŠ¤ BëŠ” ì£¼ë°© ì„œë 3ì¹¸â€ ê°™ì€ **ì •ë¦¬ ê·œì¹™**

> ê²°ë¡ : ê°œë°œìëŠ” â€œì–´ë””ì— ë¬´ì—‡ì„ ë„£ì„ì§€â€ ê³ ë¯¼í•˜ì§€ ë§ê³ , **íŒŒì‹± ì½”ë“œë§Œ** ì§œë©´ ë©ë‹ˆë‹¤.

---

## 1) Target Schema (Seed ì ì¬ìš© ìµœì†Œ í…Œì´ë¸”)
> âš ï¸ ì§€ê¸ˆ Phaseì—ì„œëŠ” â€œì™„ë²½í•œ ì˜ë¯¸ ë¶„ë¥˜â€ë³´ë‹¤ **ì•ˆì „í•œ ì ì¬ + ì¶œì²˜ ì¶”ì **ì´ ìš°ì„ ì…ë‹ˆë‹¤.  
> ë”°ë¼ì„œ 1ì°¨ ì ì¬ëŠ” ì•„ë˜ ë‘ í…Œì´ë¸”ë¡œ **ì›ë³¸ì„ ì•ˆì „í•˜ê²Œ ë³´ê´€**í•˜ê³ ,  
> ê·¸ ë‹¤ìŒ ë‹¨ê³„(2ì°¨ ETL/LLM ìƒì„±)ì—ì„œ `INTERPRETATION_BASE` ê°™ì€ â€œì •ì œ DBâ€ë¥¼ ë§Œë“­ë‹ˆë‹¤.

### 1.1 `seed_documents` (ë¬¸ì„œ ë‹¨ìœ„ ë³´ê´€: TXT/CSV ì›ë¬¸ ì¶œì²˜)
- ì—­í• : â€œì–´ëŠ íŒŒì¼ì˜ ì–´ëŠ ë¬¸ì„œì—ì„œ ì™”ëŠ”ì§€â€ ì¶”ì  ê°€ëŠ¥í•œ ì›ë¬¸ ë³´ê´€ì†Œ

```sql
CREATE TABLE seed_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_file TEXT NOT NULL,        -- ì˜ˆ: '@1_8_í†µí•©ìë£Œ.txt'
  source_doc_title TEXT,            -- ì˜ˆ: '1_í™©ì œë‚´ê²½.txt' (BEGIN/markerì—ì„œ ì¶”ì¶œ)
  source_doc_index INT NOT NULL,    -- íŒŒì¼ ë‚´ë¶€ ë¬¸ì„œ ìˆœì„œ(0..)
  raw_text TEXT NOT NULL,           -- ë¬¸ì„œ ì „ì²´ ì›ë¬¸(ë˜ëŠ” í° ê²½ìš° chunkë¡œ ìª¼ê°œë„ ë¨)
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### 1.2 `saju_contents` (ê²€ìƒ‰/í™œìš© ë‹¨ìœ„: â€œì„¹ì…˜/ì²­í¬â€)
- ì—­í• : ì•±/RAG/ë¦¬í¬íŠ¸ ìƒì„±ì´ ê°€ì ¸ë‹¤ ì“°ê¸° ì¢‹ì€ ë‹¨ìœ„ë¡œ ì˜ë¼ ì €ì¥

```sql
CREATE TABLE saju_contents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category TEXT NOT NULL,            -- ë‚´ë¶€ ì¹´í…Œê³ ë¦¬(ì•„ë˜ ê·œì¹™)
  logic_key TEXT NOT NULL,           -- ì•ˆì •ì ì¸ í‚¤(ì•„ë˜ ê·œì¹™)
  title TEXT,                        -- ì‚¬ìš©ìì—ê²Œ ë³´ì¼ ì œëª©(ì„¹ì…˜ íƒ€ì´í‹€)
  content_template TEXT NOT NULL,    -- ë³¸ë¬¸(ì¤„ë°”ê¿ˆ ìœ ì§€)
  source_file TEXT NOT NULL,         -- ì¶œì²˜ íŒŒì¼ëª…
  source_ref JSONB DEFAULT '{}'::jsonb, -- doc_title, heading_path, index ë“±
  metadata JSONB DEFAULT '{}'::jsonb,   -- tags, level, date, link ë“±
  created_at TIMESTAMPTZ DEFAULT now()
);

-- ë©±ë“±(ì¤‘ë³µ ë°©ì§€) í•µì‹¬ ìœ ë‹ˆí¬ í‚¤(ê°•ì œ)
CREATE UNIQUE INDEX IF NOT EXISTS uq_saju_contents_key
  ON saju_contents(category, logic_key);
```

> âœ… ì™œ 2í…Œì´ë¸”ì¸ê°€?
- `seed_documents`: â€œì›ë³¸ í†µì§¸ë¡œâ€ ë³´ê´€(ë‚˜ì¤‘ì— ì˜¤ë¥˜/ì¶œì²˜ ì¶”ì  ê°€ëŠ¥)
- `saju_contents`: â€œì‹¤ì œë¡œ ì“°ê¸° ì¢‹ê²Œâ€ ì¡°ê°ë‚¸ ì¡°ë¦¬ëœ ì¬ë£Œ

---

## 2) Source Inventory (ì´ë²ˆ í”„ë¡œì íŠ¸ì— ì‹¤ì œë¡œ ìˆëŠ” íŒŒì¼ ëª©ë¡)
| íŒŒì¼ | íƒ€ì… | ê·œëª¨ | ì»¬ëŸ¼/íŠ¹ì§• |
|---|---:|---:|---|
| `@ì‚¼ì†¡ì‚¬ì£¼_í†µí•©_ì •ë¦¬ë³¸.csv` | CSV | 472 rows | id, category, title, link, date_iso, content, source_file<br/>top category: {'ê¸°ì´ˆ': 331, 'ì¤‘ê¸‰': 81, '60ê°‘ì': 60} |
| `@ì–´ë°”ì›ƒì‚¬ì£¼.csv` | CSV | 31 rows | id, content, source_file<br/> |
| `@í•´ë°_í´ë¦°_ì˜¤í”„ë‹ì œê±°_í†µí•©.csv` | CSV | 1,442 rows | id, title, url, date_iso, category, content, source_file<br/>top category: {'í•´ë°ì˜ ëª…ë¦¬ ê³µë¶€': 1067, 'íˆ¬ì ë‹¨ìƒ(æ–·æƒ³)': 112, 'ê¸ˆìœµ, ì¢…ëª©, ì‚°ì—…ë¶„ì„': 60} |
| `@í˜„ë¬˜_í†µí•©_í´ë¦°_ì˜¤í”„ë‹ì œê±°.csv` | CSV | 1,000 rows | id, source_file, title, detail_title, link, date_iso, content<br/> |
| `@1_8_í†µí•©ìë£Œ.txt` | TXT | 0.09 MB | doc markers: 8 |
| `@ê³ ì „í†µí•©_ì›ë¬¸_ëª…ë¦¬5ì¢…+ëª…ë¦¬ì •ì¢….txt` | TXT | 0.19 MB | doc markers: 6 |
| `@ì„ ìš´_ìë£Œ2ê°œ_í†µí•©ì›ë¬¸.txt` | TXT | 0.45 MB | doc markers: 2 |
| `@ë„í™”ë„ë¥´_ì›ë¬¸_ì¤‘ë³µì œê±°_í†µí•©ì›ë³¸.txt` | TXT | 3.46 MB | markers ì—†ìŒ(ê·œì¹™/ê¸¸ì´ ê¸°ë°˜ ë¶„í•  í•„ìš”) |
| `@ëª…ë¦¬í•™ (ê¸°íƒ€ì‚¬ì£¼ ê°•ì˜ ëª¨ìŒ).txt` | TXT | 0.62 MB | markers ì—†ìŒ(ê·œì¹™/ê¸¸ì´ ê¸°ë°˜ ë¶„í•  í•„ìš”) |
| `@ìµ¸ì½”ì„œë‹¹ ì´ˆëª… ìœ íŠœë¸Œ ì •ë¦¬.txt` | TXT | 1.83 MB | markers ì—†ìŒ(ê·œì¹™/ê¸¸ì´ ê¸°ë°˜ ë¶„í•  í•„ìš”) |

---

## 3) ê³µí†µ ê·œì¹™ (ëª¨ë“  íŒŒì¼ì— ì ìš©ë˜ëŠ” ê¸°ë³¸ ê·œì¹™)
### 3.1 ë©±ë“±ì„±(Idempotency) â€” ë¬´ì¡°ê±´
- seedë¥¼ 10ë²ˆ ì‹¤í–‰í•´ë„ ë°ì´í„°ê°€ **ì¤‘ë³µ ì ì¬ë˜ë©´ ì‹¤íŒ¨**
- ê°•ì œ ê·œì¹™:
  - `saju_contents`: `(category, logic_key)` ìœ ë‹ˆí¬ + UPSERT
  - `seed_documents`: `(source_file, source_doc_index)` ìœ ë‹ˆí¬(ê¶Œì¥)

### 3.2 ì¤„ë°”ê¿ˆ/ë”°ì˜´í‘œ ë³´ì¡´
- `content_template`ëŠ” ì¤„ë°”ê¿ˆ(\n)ì„ **ê·¸ëŒ€ë¡œ ìœ ì§€**
- CSV ë‚´ë¶€ ë”°ì˜´í‘œ/ì‰¼í‘œê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡:
  - íŒŒì„œ: `papaparse` ë˜ëŠ” `csv-parse` ê¶Œì¥(í˜¹ì€ pandasë¡œ ì‚¬ì „ ì ê²€)

### 3.3 ìµœì†Œ í’ˆì§ˆ ê²€ì¦(Validation)
- ì•„ë˜ ì¡°ê±´ì´ë©´ **SKIP + ë¡œê·¸**:
  - contentê°€ ë¹„ì–´ìˆìŒ / 10ì ë¯¸ë§Œ
  - id/logic_keyê°€ ë¹„ì–´ìˆìŒ
- ì ì¬ í›„ â€œí•„ìˆ˜ ë ˆì½”ë“œ ìˆ˜â€ ìµœì†Œì¹˜ í™•ì¸:
  - ì˜ˆ: ì´ ì ì¬ Nê°œ ì´ìƒ, íŒŒì¼ë³„ ìµœì†Œ Mê°œ ì´ìƒ

---

## 4) Category/Logic Key ê·œê²© (ì¤‘ìš”)
### 4.1 category ë‚´ë¶€ í‘œì¤€(í˜„ì‹¤ì ì¸ ìµœì†Œ ì„¸íŠ¸)
> Phase 1 seedì˜ ëª©í‘œëŠ” â€œì •êµí•œ ë¶„ë¥˜â€ê°€ ì•„ë‹ˆë¼ **ì•ˆì „í•œ ë¶„ë¥˜**ì…ë‹ˆë‹¤.

- `general` : ì¼ë°˜ ëª…ë¦¬/í†µë³€/ê¸°ì´ˆ
- `ganji` : ì²œê°„/ì§€ì§€/60ê°‘ì/ì¼ì£¼
- `ten_gods` : ì‹­ì„±/ì‹­ì‹ 
- `five_elements` : ì˜¤í–‰(ëª©í™”í† ê¸ˆìˆ˜)
- `twelve_growth` : ì‹­ì´ìš´ì„±
- `year_fortune` : ì—°ìš´/ì„¸ìš´(ì˜ˆ: 2026ë…„ ìš´ì„¸â€¦)
- `investment` : íˆ¬ì/ê¸ˆìœµ ê´€ë ¨
- `health` : í™©ì œë‚´ê²½/ì˜¤í–‰ ê±´ê°•
- `rag_source` : ê·œì¹™ì  ë§¤í•‘ì´ ì–´ë ¤ìš´ â€œìë£Œì°½ê³ â€(í–¥í›„ ì„ë² ë”©/RAGìš©)

### 4.2 logic_key ìƒì„± ê·œì¹™(ìš°ì„ ìˆœìœ„ ê³ ì •)
- **ìš°ì„ ìˆœìœ„ 1 (CSV)**: `id` ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ **logic_key = id**
- **ìš°ì„ ìˆœìœ„ 2 (TXT ì„¹ì…˜)**:  
  `logic_key = sha1(source_file + '|' + source_doc_title + '|' + heading_path + '|' + section_index).slice(0,16)`
  - ì´ìœ : ì œëª©/ë„ì–´ì“°ê¸° ë°”ë€Œì–´ë„ í‚¤ê°€ ì•ˆì •ì ì´ì–´ì•¼ í•¨
- **ì ˆëŒ€ ê¸ˆì§€**: titleì„ ê·¸ëŒ€ë¡œ logic_keyë¡œ ì“°ê¸°(ë³€ê²½/ì¤‘ë³µ ìœ„í—˜)

---

## 5) íŒŒì¼ë³„ ë§¤í•‘ ê·œì¹™ (Source â†’ Target)

## 5A) Type A: ì •í˜• ë°ì´í„° (CSV)
### A-1) `@ì‚¼ì†¡ì‚¬ì£¼_í†µí•©_ì •ë¦¬ë³¸.csv`
- ì…ë ¥ ì»¬ëŸ¼: `id, category, title, link, date_iso, content, source_file`
- ì ì¬:
  - `saju_contents.category` = CSVì˜ `category`ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ë˜,
    - ë‚´ë¶€ í‘œì¤€ categoryë¡œ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ `metadata.source_category`ì— ì›ë³¸ ì €ì¥ + `category_map` ì ìš©(ì„ íƒ)
  - `logic_key` = `id`
  - `title` = `title`
  - `content_template` = `content`
  - `metadata.link` = `link`, `metadata.date_iso` = `date_iso`

### A-2) `@í•´ë°_í´ë¦°_ì˜¤í”„ë‹ì œê±°_í†µí•©.csv`
- ì…ë ¥ ì»¬ëŸ¼: `id, title, url, date_iso, category, content, source_file`
- ì ì¬:
  - `logic_key` = `id`
  - `metadata.link` = `url`
  - ë‚˜ë¨¸ì§€ëŠ” A-1ê³¼ ë™ì¼

### A-3) `@í˜„ë¬˜_í†µí•©_í´ë¦°_ì˜¤í”„ë‹ì œê±°.csv`
- ì…ë ¥ ì»¬ëŸ¼: `id, source_file, title, detail_title, link, date_iso, content`
- ì ì¬:
  - `logic_key` = `id`
  - `title` = `detail_title`ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„ , ì—†ìœ¼ë©´ `title`
  - `category`ëŠ” ì»¬ëŸ¼ì´ ì—†ìœ¼ë¯€ë¡œ ì•„ë˜ ê·œì¹™ìœ¼ë¡œ ìë™ ë¶€ì—¬:
    - titleì— `ë…„`, `ìš´ì„¸`, `202`(ì—°ë„) í¬í•¨ â†’ `year_fortune`
    - ê·¸ ì™¸ â†’ `general`

### A-4) `@ì–´ë°”ì›ƒì‚¬ì£¼.csv`
- ì…ë ¥ ì»¬ëŸ¼: `id, content, source_file`
- ì ì¬:
  - `logic_key` = `id`
  - `title`ì€ ì—†ìœ¼ë¯€ë¡œ ìë™ ìƒì„±:
    - contentì˜ ì²« ì¤„ì´ 3~60ìë©´ ê·¸ê±¸ titleë¡œ ì‚¬ìš©
    - ì•„ë‹ˆë©´ `AboutSaju_<built-in function id>`
  - `category` ê¸°ë³¸ê°’: `general`

---

## 5B) Type B: ë°˜ì •í˜• í…ìŠ¤íŠ¸ (TXT) â€” â€œë¬¸ì„œ/ì„¹ì…˜ ë¶„ë¦¬â€ê°€ í•µì‹¬
> TXTëŠ” â€œí—¤ë” ê¸°ì¤€ ë¶„ë¦¬â€ê°€ ì˜ ë˜ë©´ ê³ ê¸‰ ìë£Œê°€ ë˜ê³ ,  
> ë¶„ë¦¬ê°€ ì•ˆ ë˜ë©´ RAGìš© ì°½ê³ (`rag_source`)ë¡œ ë„£ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.

### B-ê³µí†µ 1) ë¬¸ì„œ(doc) ë¶„ë¦¬ ê·œì¹™(ìš°ì„ ìˆœìœ„)
1) `===== BEGIN ... =====` ë¼ì¸ì´ ìˆìœ¼ë©´: ê·¸ ë¼ì¸ë§ˆë‹¤ **ìƒˆ ë¬¸ì„œ ì‹œì‘**
   - `source_doc_title` = BEGIN ë¼ì¸ ì•ˆì˜ íŒŒì¼ëª…
2) `BEGIN FILE:` ë¼ì¸ì´ ìˆìœ¼ë©´: ê·¸ ë¼ì¸ë§ˆë‹¤ **ìƒˆ ë¬¸ì„œ ì‹œì‘**
   - `source_doc_title` = ë’¤ì˜ íŒŒì¼ëª…
3) ë‘˜ ë‹¤ ì—†ìœ¼ë©´: íŒŒì¼ ì „ì²´ë¥¼ **ë¬¸ì„œ 1ê°œ**ë¡œ ì·¨ê¸‰

### B-ê³µí†µ 2) ì„¹ì…˜(section) ë¶„ë¦¬ ê·œì¹™(ìš°ì„ ìˆœìœ„)
1) Markdown í—¤ë”: `^#(1, 6)\s+`
2) ë¡œë§ˆìˆ«ì í—¤ë”: `^(I|II|III|IV|V|VI|VII|VIII|IX|X)\.\s+`
3) ìˆ«ì/ì„œë¸Œìˆ«ì: `^\d+(\.\d+)*\.\s+`
4) ìœ„ê°€ ì „í˜€ ì—†ìœ¼ë©´: **ê¸¸ì´ ê¸°ë°˜ ì²­í¬**
   - ëª©í‘œ ê¸¸ì´: 800~1,200ì
   - ë¶„í•  ê¸°ì¤€: ë¹ˆ ì¤„(\n\n) ìš°ì„ , ì—†ìœ¼ë©´ ë¬¸ì¥ ë§ˆì¹¨í‘œ ê¸°ì¤€

### B-ê³µí†µ 3) title(ì„¹ì…˜ ì œëª©) ì¶”ì¶œ
- í—¤ë” ì¤„ ìì²´ë¥¼ titleë¡œ ì‚¬ìš©í•˜ë˜, ê¾¸ë°ˆ ì œê±°:
  - `#`, `##`, `###`, `**` ì œê±°
  - ì•ì˜ ë²ˆí˜¸(ì˜ˆ: `1.1.`) ì œê±°(ì„ íƒ)
- í—¤ë”ê°€ ì—†ê³  ê¸¸ì´ ì²­í¬ë©´:
  - ì²­í¬ ì²« ë¬¸ì¥ 40ì ì´ë‚´ë¥¼ titleë¡œ(ì—†ìœ¼ë©´ `Chunk 0`)

### B-ê³µí†µ 4) category ìë™ ë¶„ë¥˜(í‚¤ì›Œë“œ ê¸°ë°˜, ìµœì†Œ ì•ˆì „ ë²„ì „)
> ì—¬ëŸ¬ í‚¤ì›Œë“œê°€ ë™ì‹œì— ë‚˜ì˜¤ë©´ â€œìš°ì„ ìˆœìœ„â€ë¡œ 1ê°œë§Œ ì„ íƒ(ìºì‹œ/ê²€ìƒ‰ ê¼¬ì„ ë°©ì§€)

ìš°ì„ ìˆœìœ„(ìƒìœ„ê°€ ì´ê¹€):
1. `investment` : íˆ¬ì, ê¸ˆìœµ, ì¢…ëª©, ë§¤ë§¤
2. `health` : í™©ì œë‚´ê²½, ì¥ë¶€, ê²½ë½, ê±´ê°•, ì‹ì´, ì²˜ë°©
3. `twelve_growth` : ì‹­ì´ìš´ì„±
4. `ten_gods` : ì‹­ì„±, ì‹­ì‹ 
5. `five_elements` : ì˜¤í–‰, ëª©(æœ¨), í™”(ç«), í† (åœŸ), ê¸ˆ(é‡‘), ìˆ˜(æ°´)
6. `ganji` : ì²œê°„, ì§€ì§€, 60ê°‘ì, ì¼ì£¼, ê°„ì§€
7. `general` : ê·¸ ì™¸
8. (ë¶„ë¥˜ ìì‹  ì—†ìœ¼ë©´) `rag_source`

---

## 5C) Type C: ë¹„ì •í˜•/ëŒ€ìš©ëŸ‰ TXT â€” â€œRAG ì°½ê³ â€ë¡œ ì•ˆì „ ì ì¬
ì ìš© í›„ë³´:
- `@ì„ ìš´_ìë£Œ2ê°œ_í†µí•©ì›ë¬¸.txt`
- `@ë„í™”ë„ë¥´_ì›ë¬¸_ì¤‘ë³µì œê±°_í†µí•©ì›ë³¸.txt`
- `@ëª…ë¦¬í•™ (ê¸°íƒ€ì‚¬ì£¼ ê°•ì˜ ëª¨ìŒ).txt`
- `@ìµ¸ì½”ì„œë‹¹ ì´ˆëª… ìœ íŠœë¸Œ ì •ë¦¬.txt`

ê¶Œì¥ ì „ëµ:
- ë¬¸ì„œ/ì„¹ì…˜ ë¶„ë¦¬ê°€ 70% ì´ìƒ ì„±ê³µí•˜ë©´ â†’ `general/ganji/...`ë¡œ ë¶„ë¥˜í•´ì„œ `saju_contents` ì ì¬
- ì•„ë‹ˆë©´:
  - `category = rag_source`
  - `metadata.tags`ì— íŒŒì¼ëª… ê¸°ë°˜ íƒœê·¸ë§Œ ë„£ê³ ,
  - ë‚˜ì¤‘ì— ì„ë² ë”© ë‹¨ê³„ì—ì„œ ì‚¬ìš©

---

## 6) seed.ts êµ¬í˜„ ìš”êµ¬ì‚¬í•­ (ê°œë°œìê°€ ê·¸ëŒ€ë¡œ ë”°ë¼ì•¼ í•¨)
### 6.1 ì‹¤í–‰ ì»¤ë§¨ë“œ(ê³ ì •)
- `npm run seed`

### 6.2 ì²˜ë¦¬ ìˆœì„œ(ê³ ì •)
1) CSV ì ì¬ â†’ `saju_contents` UPSERT
2) TXT ë¬¸ì„œ ë¶„ë¦¬ â†’ `seed_documents` INSERT/UPSERT
3) TXT ì„¹ì…˜ ë¶„ë¦¬/ì²­í¬ â†’ `saju_contents` UPSERT
4) ê²€ì¦(ë ˆì½”ë“œ ìˆ˜/í•„ìˆ˜ í‚¤ ì¡´ì¬) â†’ ì‹¤íŒ¨ ì‹œ exit 1

### 6.3 ë¡œê¹…(í•„ìˆ˜)
- íŒŒì¼ë³„:
  - ì½ì€ ë ˆì½”ë“œ ìˆ˜ / ì ì¬ ì„±ê³µ ìˆ˜ / ìŠ¤í‚µ ìˆ˜ / ì—ëŸ¬ ìˆ˜
- ìŠ¤í‚µ ì‚¬ìœ :
  - empty content / invalid encoding / parse fail ë“±

---

## 7) ê°œë°œìì—ê²Œ ì „ë‹¬í•  â€œìµœì¢… ì§€ì‹œ ë¬¸êµ¬â€(ë³µë¶™)
> ì œê³µëœ CSV/TXT íŒŒì¼ì„ DBì— seedë¡œ ì ì¬í•´ì•¼ í•©ë‹ˆë‹¤.  
> ì´ ë¬¸ì„œ(Seed Data ETL Mapping Spec)ì˜ ê·œì¹™ëŒ€ë¡œ íŒŒì‹±/ë§¤í•‘í•˜ê³ , `npm run seed`ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.  
> íŠ¹íˆ TXTëŠ” `BEGIN/===== BEGIN` ë¬¸ì„œ ë¶„ë¦¬ â†’ í—¤ë” ê¸°ì¤€ ì„¹ì…˜ ë¶„ë¦¬ â†’ ì—†ìœ¼ë©´ ê¸¸ì´ ê¸°ì¤€ ì²­í¬ë¡œ ì ì¬í•˜ì„¸ìš”.  
> ì ì¬ëŠ” ë°˜ë“œì‹œ ë©±ë“±(Upsert)ì´ì–´ì•¼ í•˜ê³ , `(category, logic_key)` ìœ ë‹ˆí¬ë¥¼ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤.

---

## ë¶€ë¡ A) ì¶”ì²œ: ì½”ë“œì— ë°•ì•„ë‘˜ ê·œì¹™ JSON (seed_mapping_rules_v1.json)
- ì¥ì : ê°œë°œìê°€ ê·œì¹™ì„ ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ë‹¤ê°€ ë§ê°€ëœ¨ë¦¬ëŠ” ê±¸ ë°©ì§€

```json
{
  "category_priority": [
    "investment",
    "health",
    "twelve_growth",
    "ten_gods",
    "five_elements",
    "ganji",
    "general",
    "rag_source"
  ],
  "keywords": {
    "investment": [
      "íˆ¬ì",
      "ê¸ˆìœµ",
      "ì¢…ëª©",
      "ë§¤ë§¤",
      "ì°¨íŠ¸",
      "ë¦¬ìŠ¤í¬"
    ],
    "health": [
      "í™©ì œë‚´ê²½",
      "ì¥ë¶€",
      "ê²½ë½",
      "ê±´ê°•",
      "ì‹ì´",
      "ì²˜ë°©",
      "ì¹˜ë£Œ"
    ],
    "twelve_growth": [
      "ì‹­ì´ìš´ì„±",
      "ì¥ìƒ",
      "ëª©ìš•",
      "ê´€ëŒ€",
      "ê±´ë¡",
      "ì œì™•",
      "ì‡ ",
      "ë³‘",
      "ì‚¬",
      "ë¬˜",
      "ì ˆ",
      "íƒœ",
      "ì–‘"
    ],
    "ten_gods": [
      "ì‹­ì„±",
      "ì‹­ì‹ ",
      "ë¹„ê²¬",
      "ê²ì¬",
      "ì‹ì‹ ",
      "ìƒê´€",
      "í¸ì¬",
      "ì •ì¬",
      "í¸ê´€",
      "ì •ê´€",
      "í¸ì¸",
      "ì •ì¸"
    ],
    "five_elements": [
      "ì˜¤í–‰",
      "ëª©(",
      "í™”(",
      "í† (",
      "ê¸ˆ(",
      "ìˆ˜(",
      "ëª©(æœ¨)",
      "í™”(ç«)",
      "í† (åœŸ)",
      "ê¸ˆ(é‡‘)",
      "ìˆ˜(æ°´)"
    ],
    "ganji": [
      "ì²œê°„",
      "ì§€ì§€",
      "60ê°‘ì",
      "ìœ¡ì‹­ê°‘ì",
      "ì¼ì£¼",
      "ê°„ì§€"
    ]
  },
  "txt_doc_markers": [
    "^===== BEGIN .* =====$",
    "^BEGIN FILE: .*"
  ],
  "txt_heading_patterns": [
    "^#{1,6}\\s+",
    "^(I|II|III|IV|V|VI|VII|VIII|IX|X)\\.\\s+",
    "^\\d+(\\.\\d+)*\\.\\s+"
  ],
  "chunk_target_chars": [
    800,
    1200
  ],
  "logic_key_hash_len": 16
}
```
